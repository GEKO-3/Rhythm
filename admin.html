<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Rhythm Boduberu - Admin Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0">
  <meta name="description" content="Administrative panel for Rhythm Boduberu music group operations">
  <meta name="theme-color" content="#f5d000">
  <meta name="color-scheme" content="dark">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Rhythm Admin">
  <meta name="msapplication-TileColor" content="#f5d000">
  <meta name="msapplication-config" content="favicons/browserconfig.xml">
  <link rel="icon" type="image/png" sizes="192x192" href="favicons/icons-192.png">
<link rel="icon" type="image/png" sizes="512x512" href="favicons/icons-512.png">
<link rel="manifest" href="favicons/admin-manifest.webmanifest">
  
  <!-- Notification Permission Banner -->
  <div id="notification-banner" class="notification-banner" style="display: none;">
    <div class="notification-content">
      <span class="notification-text">Enable notifications to get alerts for new member applications</span>
      <div class="notification-buttons">
        <button id="enable-notifications" class="notification-btn enable">Enable</button>
        <button id="dismiss-notifications" class="notification-btn dismiss">Dismiss</button>
      </div>
    </div>
  </div>
  <style>
    /* Local font definitions */
    @font-face {
      font-family: 'Faruma';
      src: url('Fonts/Faruma.ttf') format('truetype');
      font-display: swap;
      font-weight: normal;
      font-style: normal;
    }
    
    @font-face {
      font-family: 'Montserrat';
      src: url('Fonts/Montserrat-VariableFont_wght.ttf') format('truetype');
      font-display: swap;
      font-weight: normal;
      font-style: normal;
    }
    
    body {
      background: #1f1f1f;
      color: #f5d000;
      font-family: 'Montserrat', Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      margin: 0;
      /* Support for window controls overlay */
      -webkit-app-region: no-drag;
    }
    
    /* Window controls overlay support */
    @media (display-mode: window-controls-overlay) {
      body {
        padding-top: env(titlebar-area-height, 0);
      }
      
      .settings-panel {
        top: calc(60px + env(titlebar-area-height, 0));
      }
      
      .notification-banner {
        top: env(titlebar-area-height, 0);
      }
      
      .install-btn {
        top: calc(60px + env(titlebar-area-height, 0));
      }
    }
    
    /* Standalone PWA mode adjustments */
    @media (display-mode: standalone) {
      body {
        /* Add safe area padding for notch/camera cutout */
        padding-top: env(safe-area-inset-top, 0);
      }
      
      .settings-panel {
        top: calc(60px + env(safe-area-inset-top, 0));
        right: calc(20px + env(safe-area-inset-right, 0));
      }
      
      .install-btn {
        top: calc(60px + env(safe-area-inset-top, 0));
      }
      
      .notification-banner {
        top: env(safe-area-inset-top, 0);
        padding-left: calc(20px + env(safe-area-inset-left, 0));
        padding-right: calc(20px + env(safe-area-inset-right, 0));
      }
      
      .notification-status {
        bottom: calc(20px + env(safe-area-inset-bottom, 0));
        right: calc(20px + env(safe-area-inset-right, 0));
      }
    }
    
    /* iOS specific adjustments */
    @supports (-webkit-touch-callout: none) {
      @media (display-mode: standalone) {
        body {
          padding-top: max(env(safe-area-inset-top, 0), 44px);
        }
        
        .settings-panel {
          top: calc(60px + max(env(safe-area-inset-top, 0), 44px));
        }
        
        .install-btn {
          top: calc(60px + max(env(safe-area-inset-top, 0), 44px));
        }
      }
    }
    
    /* PWA install button */
    .install-btn {
      position: fixed;
      top: 60px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(245, 208, 0, 0.9);
      color: #2b2b2b;
      border: none;
      border-radius: 25px;
      padding: 10px 20px;
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.3s ease;
      z-index: 200;
      display: none;
      font-family: 'Montserrat', Arial, sans-serif;
      backdrop-filter: blur(10px);
    }
    
    .install-btn:hover {
      background: #f5d000;
      transform: translateX(-50%) translateY(-2px);
      box-shadow: 0 4px 12px rgba(245, 208, 0, 0.3);
    }
    
    .install-btn.show {
      display: block !important;
    }
    .menu-container {
      background: rgba(43,43,43,0.7);
      width: 300px;
      border-radius: 12px;
      padding: 40px 32px;
      box-shadow: 0 2px 12px #0002;
      display: flex;
      flex-direction: column;
      gap: 24px;
      align-items: center;
    }
    .menu-btn {
      background: #f5d000;
      color: #2b2b2b;
      border: none;
      border-radius: 7px;
      padding: 16px 36px;
      font-size: 1.2em;
      font-weight: bold;
      font-family: 'Montserrat', Arial, sans-serif;
      cursor: pointer;
      transition: background 0.2s, color 0.2s;
      margin: 0 0 0 0;
      width: 220px;
    }
    .menu-btn:hover {
      background: #fced98;
      color: #111;
    }
    
    .page-title {
      font-size: 2.5em;
      font-weight: bold;
      margin-bottom: 30px;
      text-align: center;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
      font-family: 'Montserrat', Arial, sans-serif;
    }
    
    @media (max-width: 600px) {
      .page-title {
        font-size: 2em;
        margin-bottom: 20px;
      }
      .menu-container {
        padding: 24px 6vw;
      }
      .menu-btn {
        width: 100%;
        font-size: 1em;
        padding: 14px 0;
      }
    }
    
    /* PIN Entry Styles */
    .pin-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #1f1f1f;
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
    }
    
    .pin-container {
      background: rgba(43,43,43,0.9);
      padding: 30px;
      border-radius: 15px;
      text-align: center;
      border: 2px solid #444;
      max-width: 300px;
      width: 85%;
    }
    
    .pin-title {
      color: #f5d000;
      font-size: 1.3em;
      margin-bottom: 25px;
      font-family: 'Montserrat', Arial, sans-serif;
      font-weight: 600;
    }
    
    .pin-inputs {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-bottom: 20px;
    }
    
    .pin-digit {
      width: 50px;
      height: 50px;
      padding: 0;
      font-size: 1.5em;
      text-align: center;
      border: 2px solid #444;
      border-radius: 8px;
      background: #222;
      color: #f5d000;
      outline: none;
      font-family: 'Montserrat', Arial, sans-serif;
      transition: all 0.3s ease;
      caret-color: transparent;
      /* Force numerical keyboard on mobile */
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: textfield;
    }
    
    .pin-digit:focus {
      border-color: #f5d000;
      box-shadow: 0 0 0 2px rgba(245, 208, 0, 0.2);
      transform: scale(1.05);
    }
    
    .pin-digit.filled {
      background: rgba(245, 208, 0, 0.1);
      border-color: #f5d000;
    }
    
    .pin-digit.error {
      border-color: #ff6b6b;
      animation: shake 0.5s;
    }
    
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-3px); }
      75% { transform: translateX(3px); }
    }
    
    .pin-error {
      color: #ff6b6b;
      font-size: 0.85em;
      margin-top: 5px;
      min-height: 18px;
      font-family: 'Montserrat', Arial, sans-serif;
    }
    
    .pin-overlay.hidden {
      display: none;
    }
    
    /* Mobile responsive adjustments */
    @media (max-width: 400px) {
      .pin-container {
        padding: 25px;
        max-width: 280px;
      }
      
      .pin-digit {
        width: 45px;
        height: 45px;
        font-size: 1.3em;
      }
      
      .pin-inputs {
        gap: 10px;
      }
    }
    
    /* Notification Banner Styles */
    .notification-banner {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: linear-gradient(135deg, #f5d000, #ffed4e);
      color: #2b2b2b;
      padding: 15px 20px;
      z-index: 1000;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
      transform: translateY(-100%);
      transition: transform 0.3s ease;
    }

    .notification-banner.show {
      transform: translateY(0);
    }

    .notification-content {
      display: flex;
      align-items: center;
      justify-content: space-between;
      max-width: 600px;
      margin: 0 auto;
      flex-wrap: wrap;
      gap: 15px;
    }

    .notification-text {
      font-weight: 600;
      font-size: 0.95rem;
    }

    .notification-buttons {
      display: flex;
      gap: 10px;
    }

    .notification-btn {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: 'Montserrat', Arial, sans-serif;
    }

    .notification-btn.enable {
      background: #2b2b2b;
      color: #f5d000;
    }

    .notification-btn.enable:hover {
      background: #1a1a1a;
      transform: translateY(-1px);
    }

    .notification-btn.dismiss {
      background: transparent;
      color: #2b2b2b;
      border: 1px solid #2b2b2b;
    }

    .notification-btn.dismiss:hover {
      background: rgba(43, 43, 43, 0.1);
    }

    /* Notification Status Indicator */
    .notification-status {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: rgba(43, 43, 43, 0.9);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(245, 208, 0, 0.3);
      border-radius: 10px;
      padding: 10px 15px;
      color: #f5d000;
      font-size: 0.9rem;
      font-weight: 600;
      z-index: 100;
      display: none;
      font-family: 'Montserrat', Arial, sans-serif;
    }

    .notification-status.enabled {
      display: block;
    }

    .notification-status .status-icon {
      margin-right: 8px;
    }

    /* Settings Panel Styles */
    .settings-panel {
      position: fixed;
      top: 60px;
      right: 20px;
      z-index: 150;
    }

    .settings-btn {
      background: rgba(43, 43, 43, 0.9);
      border: 1px solid rgba(245, 208, 0, 0.3);
      color: #f5d000;
      padding: 12px;
      border-radius: 50%;
      cursor: pointer;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
      font-size: 1.2rem;
    }

    .settings-btn:hover {
      background: rgba(245, 208, 0, 0.1);
      transform: rotate(90deg);
    }

    .settings-dropdown {
      position: absolute;
      top: 100%;
      right: 0;
      background: rgba(43, 43, 43, 0.95);
      backdrop-filter: blur(15px);
      border: 1px solid rgba(245, 208, 0, 0.3);
      border-radius: 10px;
      padding: 15px;
      margin-top: 10px;
      min-width: 250px;
      display: none;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
    }

    .settings-dropdown.show {
      display: block;
    }

    .settings-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid rgba(245, 208, 0, 0.1);
      font-size: 0.9rem;
    }

    .settings-item:last-child {
      border-bottom: none;
    }

    .settings-label {
      color: #f5d000;
      font-weight: 600;
    }

    .settings-value {
      color: #cccccc;
      font-size: 0.85rem;
    }

    .toggle-switch {
      position: relative;
      width: 50px;
      height: 25px;
      background: #444;
      border-radius: 25px;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    .toggle-switch.enabled {
      background: #f5d000;
    }

    .toggle-switch::after {
      content: '';
      position: absolute;
      width: 21px;
      height: 21px;
      background: white;
      border-radius: 50%;
      top: 2px;
      left: 2px;
      transition: transform 0.3s ease;
    }

    .toggle-switch.enabled::after {
      transform: translateX(25px);
    }

    @media (max-width: 600px) {
      .notification-content {
        flex-direction: column;
        text-align: center;
        gap: 10px;
      }
      
      .settings-panel {
        top: calc(60px + env(safe-area-inset-top, 0));
        right: calc(15px + env(safe-area-inset-right, 0));
      }
      
      .settings-dropdown {
        min-width: 200px;
        right: -50px;
      }
      
      .install-btn {
        top: calc(60px + env(safe-area-inset-top, 0));
        font-size: 0.85rem;
        padding: 8px 16px;
      }
    }
  </style>
</head>
<body>
  <!-- PIN Overlay -->
  <div class="pin-overlay" id="pin-overlay">
    <div class="pin-container">
      <h2 class="pin-title">Admin Access</h2>
      <div class="pin-inputs">
        <input type="tel" inputmode="numeric" pattern="[0-9]*" class="pin-digit" id="pin-digit-0" maxlength="1" autocomplete="off" />
        <input type="tel" inputmode="numeric" pattern="[0-9]*" class="pin-digit" id="pin-digit-1" maxlength="1" autocomplete="off" />
        <input type="tel" inputmode="numeric" pattern="[0-9]*" class="pin-digit" id="pin-digit-2" maxlength="1" autocomplete="off" />
        <input type="tel" inputmode="numeric" pattern="[0-9]*" class="pin-digit" id="pin-digit-3" maxlength="1" autocomplete="off" />
      </div>
      <div class="pin-error" id="pin-error"></div>
    </div>
  </div>

  <!-- PWA Install Button -->
  <button id="install-btn" class="install-btn">📱 Install Admin App</button>

  <!-- Settings Panel -->
  <div class="settings-panel">
    <button class="settings-btn" id="settings-btn" title="Settings">⚙️</button>
    <div class="settings-dropdown" id="settings-dropdown">
      <div class="settings-item">
        <span class="settings-label">Notifications</span>
        <div class="toggle-switch" id="notification-toggle" title="Toggle notifications">
        </div>
      </div>
      <div class="settings-item">
        <div>
          <div class="settings-label">Status</div>
          <div class="settings-value" id="notification-status-text">Checking...</div>
        </div>
      </div>
    </div>
  </div>

  <h1 class="page-title">Admin</h1>
  <div class="menu-container">
    <button class="menu-btn" onclick="navigateToPage('members.html')">Members</button>
    <button class="menu-btn" onclick="navigateToPage('songlist.html')">Song List</button>
    <button class="menu-btn" onclick="navigateToPage('lyrics-edit.html')">Lyrics Editor</button>
    <button class="menu-btn" onclick="navigateToPage('show-list-generator.html')">Show List</button>
    <button class="menu-btn" onclick="navigateToPage('applications-list.html')">Applications</button>
    <button class="menu-btn" onclick="navigateToPage('sponsors-list.html')">Sponsor Callbacks</button>
  </div>

  <!-- Notification Status Indicator -->
  <div id="notification-status-indicator" class="notification-status">
    <span class="status-icon">🔔</span>
    <span>Notifications enabled</span>
  </div>

  <script>
    // PWA Installation Management
    let deferredPrompt;
    let isInstalled = false;

    // Check if app is installed
    function checkInstallStatus() {
      // Check if running as installed PWA
      if (window.matchMedia('(display-mode: standalone)').matches ||
          window.matchMedia('(display-mode: window-controls-overlay)').matches ||
          window.navigator.standalone === true) {
        isInstalled = true;
        document.getElementById('install-btn').style.display = 'none';
        return true;
      }
      return false;
    }

    // PWA Install button handling
    window.addEventListener('beforeinstallprompt', (e) => {
      console.log('PWA install prompt available');
      e.preventDefault();
      deferredPrompt = e;
      
      // Only show install button if not already installed and user is authenticated
      if (!isInstalled && pinAuthenticated) {
        const installBtn = document.getElementById('install-btn');
        installBtn.classList.add('show');
        console.log('Install button should now be visible');
      }
    });

    // Also check if we can show install button on load (for testing)
    function checkAndShowInstallButton() {
      console.log('Checking install button conditions:', {
        isInstalled,
        pinAuthenticated,
        protocol: window.location.protocol,
        hostname: window.location.hostname
      });
      
      if (!isInstalled && pinAuthenticated) {
        const installBtn = document.getElementById('install-btn');
        // Show button for testing even without beforeinstallprompt event
        // This helps with file:// protocol testing and browsers that don't fire the event
        installBtn.classList.add('show');
        console.log('Install button shown');
      }
    }

    // Handle install button click
    document.getElementById('install-btn').addEventListener('click', async () => {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        
        if (outcome === 'accepted') {
          console.log('PWA installed successfully');
          document.getElementById('install-btn').classList.remove('show');
        } else {
          console.log('PWA installation dismissed');
        }
        
        deferredPrompt = null;
      } else {
        // Fallback for browsers that don't support beforeinstallprompt
        alert('To install this app:\n\n1. Open browser menu (⋮)\n2. Select "Install app" or "Add to Home Screen"\n3. Follow the prompts');
      }
    });

    // Listen for app installation
    window.addEventListener('appinstalled', (evt) => {
      console.log('PWA was installed');
      isInstalled = true;
      document.getElementById('install-btn').classList.remove('show');
      
      // Show success notification if notifications are enabled
      if (checkNotificationPermission() === 'granted') {
        new Notification('Rhythm Admin Installed!', {
          body: 'The admin app has been installed successfully',
          icon: 'favicons/favicon.png',
          badge: 'favicons/favicon.png',
          tag: 'app-installed'
        });
      }
    });

    // Notification functionality
    let notificationPermission = 'default';
    let hasShownNotificationBanner = false;

    // Check if notifications are supported
    function isNotificationSupported() {
      return 'Notification' in window && 'serviceWorker' in navigator;
    }

    // Check notification permission status
    function checkNotificationPermission() {
      if (!isNotificationSupported()) return 'unsupported';
      return Notification.permission;
    }

    // Show notification banner
    function showNotificationBanner() {
      if (!isNotificationSupported() || hasShownNotificationBanner) return;
      
      const banner = document.getElementById('notification-banner');
      const permission = checkNotificationPermission();
      
      if (permission === 'default') {
        banner.style.display = 'block';
        setTimeout(() => banner.classList.add('show'), 100);
        hasShownNotificationBanner = true;
        
        // Auto-hide after 10 seconds if no action taken
        setTimeout(() => {
          if (banner.classList.contains('show')) {
            hideNotificationBanner();
          }
        }, 10000);
      }
    }

    // Hide notification banner
    function hideNotificationBanner() {
      const banner = document.getElementById('notification-banner');
      banner.classList.remove('show');
      setTimeout(() => banner.style.display = 'none', 300);
    }

    // Request notification permission
    async function requestNotificationPermission() {
      if (!isNotificationSupported()) {
        console.log('Notifications not supported');
        return false;
      }

      try {
        const permission = await Notification.requestPermission();
        notificationPermission = permission;
        
        if (permission === 'granted') {
          // Register service worker for better notification handling
          if ('serviceWorker' in navigator) {
            try {
              await navigator.serviceWorker.register('sw-notifications.js');
              console.log('Notification service worker registered');
            } catch (error) {
              console.log('Service worker registration failed:', error);
            }
          }
          
          updateNotificationStatus();
          updateSettingsPanel();
          showTestNotification();
          hideNotificationBanner();
          return true;
        } else {
          console.log('Notification permission denied');
          updateNotificationStatus();
          updateSettingsPanel();
          return false;
        }
      } catch (error) {
        console.error('Error requesting notification permission:', error);
        return false;
      }
    }

    // Show test notification
    function showTestNotification() {
      if (checkNotificationPermission() !== 'granted') return;

      const notification = new Notification('Rhythm Boduberu - Admin Panel', {
        body: 'Notifications are now enabled for admin functions',
        icon: 'favicons/favicon.png',
        badge: 'favicons/favicon.png',
        tag: 'admin-test-notification',
        requireInteraction: false,
        silent: false
      });

      // Auto-close after 5 seconds
      setTimeout(() => notification.close(), 5000);
    }

    // Show new application notification
    function showNewApplicationNotification(applicationCount) {
      if (checkNotificationPermission() !== 'granted') return;

      const title = applicationCount === 1 
        ? 'New Member Application!' 
        : `${applicationCount} New Member Applications!`;
      
      const body = applicationCount === 1
        ? 'A new member application has been submitted'
        : `${applicationCount} new member applications have been submitted`;

      const notification = new Notification(title, {
        body: body,
        icon: 'favicons/favicon.png',
        badge: 'favicons/favicon.png',
        tag: 'new-application',
        requireInteraction: true,
        silent: false
      });

      // Handle notification click
      notification.onclick = function() {
        window.focus();
        // Navigate to applications if in admin panel
        navigateToPage('applications-list.html');
        notification.close();
      };

      // Auto-close after 15 seconds if not clicked
      setTimeout(() => notification.close(), 15000);
    }

    // Update notification status indicator
    function updateNotificationStatus() {
      const statusElement = document.getElementById('notification-status-indicator');
      const permission = checkNotificationPermission();
      
      if (permission === 'granted') {
        statusElement.classList.add('enabled');
      } else {
        statusElement.classList.remove('enabled');
      }
    }

    // Update settings panel
    function updateSettingsPanel() {
      const toggle = document.getElementById('notification-toggle');
      const statusText = document.getElementById('notification-status-text');
      const permission = checkNotificationPermission();
      
      if (permission === 'granted') {
        toggle.classList.add('enabled');
        statusText.textContent = 'Enabled';
        statusText.style.color = '#44ff44';
      } else if (permission === 'denied') {
        toggle.classList.remove('enabled');
        statusText.textContent = 'Blocked';
        statusText.style.color = '#ff4444';
      } else if (permission === 'default') {
        toggle.classList.remove('enabled');
        statusText.textContent = 'Not set';
        statusText.style.color = '#ffaa00';
      } else {
        toggle.classList.remove('enabled');
        statusText.textContent = 'Not supported';
        statusText.style.color = '#666666';
      }
    }

    // Initialize notification system
    function initializeNotifications() {
      if (!isNotificationSupported()) {
        console.log('Notifications not supported on this device/browser');
        return;
      }

      notificationPermission = checkNotificationPermission();
      updateNotificationStatus();
      updateSettingsPanel();

      // Show banner after PIN authentication if permission not yet decided
      if (pinAuthenticated && notificationPermission === 'default') {
        setTimeout(() => {
          showNotificationBanner();
        }, 2000);
      }

      // Set up banner button handlers
      const enableBtn = document.getElementById('enable-notifications');
      const dismissBtn = document.getElementById('dismiss-notifications');

      enableBtn?.addEventListener('click', async () => {
        await requestNotificationPermission();
      });

      dismissBtn?.addEventListener('click', () => {
        hasShownNotificationBanner = true;
        hideNotificationBanner();
      });

      // Set up settings panel handlers
      const settingsBtn = document.getElementById('settings-btn');
      const settingsDropdown = document.getElementById('settings-dropdown');
      const notificationToggle = document.getElementById('notification-toggle');

      settingsBtn?.addEventListener('click', (e) => {
        e.stopPropagation();
        settingsDropdown.classList.toggle('show');
      });

      // Close settings dropdown when clicking outside
      document.addEventListener('click', () => {
        settingsDropdown.classList.remove('show');
      });

      settingsDropdown?.addEventListener('click', (e) => {
        e.stopPropagation();
      });

      notificationToggle?.addEventListener('click', async () => {
        const permission = checkNotificationPermission();
        
        if (permission === 'default') {
          await requestNotificationPermission();
        } else if (permission === 'granted') {
          // Can't programmatically disable notifications, show info
          alert('To disable notifications, please use your browser settings:\n\n1. Click the lock/info icon in the address bar\n2. Change notification permission to "Block"\n3. Refresh the page');
        } else if (permission === 'denied') {
          // Show instructions to re-enable
          alert('To enable notifications:\n\n1. Click the lock/info icon in the address bar\n2. Change notification permission to "Allow"\n3. Refresh the page');
        }
      });

      // Register service worker if supported and permission granted
      if (notificationPermission === 'granted' && 'serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw-notifications.js')
          .then(() => console.log('Service worker registered'))
          .catch(error => console.log('Service worker registration failed:', error));
      }
    }

    // Simulate periodic check for new applications (for demo)
    function startApplicationMonitoring() {
      if (checkNotificationPermission() !== 'granted') return;
      
      // This would normally check your backend/CSV for new applications
      // For demo purposes, we'll simulate a new application every 2 minutes
      setInterval(() => {
        // In real implementation, this would check against your data source
        const shouldNotify = Math.random() > 0.95; // 5% chance every 2 minutes
        
        if (shouldNotify) {
          showNewApplicationNotification(1);
        }
      }, 120000); // 2 minutes
    }

    // PIN Configuration - Admin PIN (base64 encoded: 8734)
    const encodedAdminPin = 'ODczNA==';
    let actualPinArray = [];
    let pinAuthenticated = false;
    let pinOverlay, pinDigits, pinError;
    let attemptCount = 0;
    const maxAttempts = 5;
    const lockoutDuration = 60 * 60 * 1000; // 1 hour in milliseconds
    let lockoutTimer = null;
    
    // Session timeout system
    const sessionTimeout = 3 * 60 * 1000; // 3 minutes in milliseconds
    let sessionTimer = null;
    let lastActivityTime = Date.now();
    let isPageVisible = true;
    
    // Initialize PIN system on page load
    document.addEventListener('DOMContentLoaded', function() {
      decodePinConfig();
      initializePinSystem();
      initializeSessionTimeout();
      checkInstallStatus();
    });
    
    // Decode and validate PIN configuration
    function decodePinConfig() {
      try {
        const decoded = atob(encodedAdminPin);
        actualPinArray = decoded.split('').map(Number);
        
        if (actualPinArray.length !== 4 || actualPinArray.some(isNaN)) {
          throw new Error('Invalid PIN configuration');
        }
      } catch (e) {
        console.error('PIN configuration error:', e);
        actualPinArray = [8, 7, 3, 4]; // Fallback
      }
    }
    
    function initializeSessionTimeout() {
      // Track page visibility
      document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
          isPageVisible = false;
          // Start session timeout when page goes out of focus
          if (pinAuthenticated) {
            startSessionTimeout();
          }
        } else {
          isPageVisible = true;
          // Clear session timeout when page comes back into focus
          clearSessionTimeout();
          updateLastActivity();
        }
      });
      
      // Track user activity to reset session timer
      const activityEvents = ['click', 'keydown', 'scroll', 'touchstart', 'mousemove'];
      activityEvents.forEach(event => {
        document.addEventListener(event, updateLastActivity, true);
      });
      
      // For mobile apps, also track window focus/blur
      window.addEventListener('focus', function() {
        isPageVisible = true;
        clearSessionTimeout();
        updateLastActivity();
      });
      
      window.addEventListener('blur', function() {
        isPageVisible = false;
        if (pinAuthenticated) {
          startSessionTimeout();
        }
      });
    }
    
    function updateLastActivity() {
      lastActivityTime = Date.now();
      if (pinAuthenticated && !isPageVisible) {
        // Reset session timeout if user becomes active while page is hidden
        clearSessionTimeout();
        startSessionTimeout();
      }
    }
    
    function startSessionTimeout() {
      clearSessionTimeout(); // Clear any existing timeout
      
      sessionTimer = setTimeout(() => {
        if (pinAuthenticated && !isPageVisible) {
          // Session expired - require PIN re-entry
          expireSession();
        }
      }, sessionTimeout);
    }
    
    function clearSessionTimeout() {
      if (sessionTimer) {
        clearTimeout(sessionTimer);
        sessionTimer = null;
      }
    }
    
    function expireSession() {
      pinAuthenticated = false;
      sessionStorage.removeItem('pinSession');
      
      // Clear session timeout
      clearSessionTimeout();
      
      // Show PIN overlay again
      pinOverlay.classList.remove('hidden');
      clearPinInputs();
      
      // Focus on first digit when user returns
      setTimeout(() => {
        pinDigits[0].focus();
        
        // Force keyboard to open on mobile devices
        if (window.innerWidth <= 768 || /iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
          pinDigits[0].click();
          setTimeout(() => {
            pinDigits[0].focus();
          }, 100);
        }
      }, 300);
      
      // Show session expired message
      showPinError('Session expired. Please enter PIN again.');
      setTimeout(() => {
        clearPinError();
      }, 3000);
    }
    
    function initializePinSystem() {
      pinOverlay = document.getElementById('pin-overlay');
      pinDigits = [
        document.getElementById('pin-digit-0'),
        document.getElementById('pin-digit-1'),
        document.getElementById('pin-digit-2'),
        document.getElementById('pin-digit-3')
      ];
      pinError = document.getElementById('pin-error');
      
      // Check if PIN was previously entered
      checkPinStatus();
      
      // Setup event listeners for each digit input
      pinDigits.forEach((digit, index) => {
        digit.addEventListener('input', function(e) {
          handleDigitInput(e, index);
        });
        
        digit.addEventListener('keydown', function(e) {
          handleDigitKeydown(e, index);
        });
        
        digit.addEventListener('paste', function(e) {
          handlePaste(e);
        });
        
        // Mobile focus improvements
        digit.addEventListener('focus', function() {
          // Ensure keyboard opens on mobile
          if (window.innerWidth <= 768 || /iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
            setTimeout(() => {
              digit.focus();
              digit.click();
            }, 50);
          }
        });
        
        // Additional mobile keyboard trigger
        digit.addEventListener('touchstart', function(e) {
          if (window.innerWidth <= 768 || /iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
            setTimeout(() => {
              digit.focus();
            }, 50);
          }
        });
      });
      
      // Auto-focus first digit with delay for mobile
      setTimeout(() => {
        if (pinOverlay && !pinOverlay.classList.contains('hidden')) {
          pinDigits[0].focus();
          
          // Force keyboard to open on mobile devices
          if (window.innerWidth <= 768 || /iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
            // Multiple attempts to ensure keyboard opens
            pinDigits[0].click();
            setTimeout(() => {
              pinDigits[0].focus();
              pinDigits[0].click();
            }, 100);
            setTimeout(() => {
              pinDigits[0].focus();
            }, 200);
          }
        }
      }, 500); // Increased delay to ensure DOM is ready
    }
    
    function handleDigitInput(e, index) {
      // Check if locked out
      if (e.target.disabled) return;
      
      const value = e.target.value;
      
      // Only allow single digit numbers
      if (!/^\d$/.test(value)) {
        e.target.value = '';
        return;
      }
      
      // Clear any previous errors
      clearPinError();
      
      // Mark as filled
      e.target.classList.add('filled');
      
      // Move to next digit
      if (index < 3) {
        pinDigits[index + 1].focus();
      } else {
        // All digits filled, verify PIN
        setTimeout(() => verifyPin(), 100);
      }
    }
    
    function handleDigitKeydown(e, index) {
      // Check if locked out
      if (e.target.disabled) return;
      
      // Handle backspace
      if (e.key === 'Backspace') {
        if (e.target.value === '' && index > 0) {
          // Move to previous digit if current is empty
          pinDigits[index - 1].focus();
          pinDigits[index - 1].value = '';
          pinDigits[index - 1].classList.remove('filled');
        } else {
          // Clear current digit
          e.target.value = '';
          e.target.classList.remove('filled');
        }
      }
      
      // Handle Enter key
      if (e.key === 'Enter') {
        verifyPin();
      }
      
      // Handle arrow keys
      if (e.key === 'ArrowLeft' && index > 0) {
        pinDigits[index - 1].focus();
      }
      if (e.key === 'ArrowRight' && index < 3) {
        pinDigits[index + 1].focus();
      }
    }
    
    function handlePaste(e) {
      e.preventDefault();
      const pasteData = e.clipboardData.getData('text');
      
      // Check if pasted data is 4 digits
      if (/^\d{4}$/.test(pasteData)) {
        const digits = pasteData.split('');
        pinDigits.forEach((digit, index) => {
          digit.value = digits[index];
          digit.classList.add('filled');
        });
        setTimeout(() => verifyPin(), 100);
      }
    }
    
    function checkPinStatus() {
      // Check if currently locked out
      const lockoutEnd = localStorage.getItem('pinLockoutEnd');
      if (lockoutEnd && Date.now() < parseInt(lockoutEnd)) {
        startLockoutTimer(parseInt(lockoutEnd));
        return;
      }
      
      // Clear any expired lockout
      if (lockoutEnd && Date.now() >= parseInt(lockoutEnd)) {
        localStorage.removeItem('pinLockoutEnd');
        localStorage.removeItem('pinAttemptCount');
        attemptCount = 0;
      }
      
      // Restore attempt count if not locked out
      const savedAttempts = localStorage.getItem('pinAttemptCount');
      if (savedAttempts) {
        attemptCount = parseInt(savedAttempts);
      }
      
      // Check for existing valid session 
      const sessionData = sessionStorage.getItem('pinSession');
      if (sessionData) {
        try {
          const session = JSON.parse(sessionData);
          const sessionAge = Date.now() - session.timestamp;
          
          // Session is valid if authenticated and less than 3 minutes old (with 10 second buffer for navigation)
          if (session.authenticated && sessionAge < (sessionTimeout + 10000)) {
            // If there's ANY valid session (admin or songlist), allow access and upgrade to admin
            pinAuthenticated = true;
            // Refresh session timestamp and ensure admin type
            const refreshedSession = {
              timestamp: Date.now(),
              authenticated: true,
              sessionType: 'admin'
            };
            sessionStorage.setItem('pinSession', JSON.stringify(refreshedSession));
            updateLastActivity();
            pinOverlay.classList.add('hidden');
            
            // Initialize notifications for existing sessions
            setTimeout(() => {
              initializeNotifications();
              startApplicationMonitoring();
              
              // Show install button if PWA can be installed
              checkAndShowInstallButton();
              if (deferredPrompt && !isInstalled) {
                document.getElementById('install-btn').classList.add('show');
              }
            }, 500);
            return;
          } else {
            // Session expired, remove it
            sessionStorage.removeItem('pinSession');
          }
        } catch (e) {
          // Invalid session data, remove it
          sessionStorage.removeItem('pinSession');
        }
      }
      
      // No valid session - show PIN overlay
      pinOverlay.classList.remove('hidden');
    }
    
    function verifyPin() {
      const enteredPin = pinDigits.map(digit => digit.value).join('');
      
      if (enteredPin.length !== 4) {
        showPinError('Please enter all 4 digits');
        return;
      }
      
      // Check if currently locked out
      const lockoutEnd = localStorage.getItem('pinLockoutEnd');
      if (lockoutEnd && Date.now() < parseInt(lockoutEnd)) {
        showPinError('Account is locked. Please wait.');
        return;
      }
      
      // Convert entered PIN to array for comparison
      const enteredPinArray = enteredPin.split('').map(Number);
      
      // Compare with admin PIN (8734)
      const isCorrect = enteredPinArray.every((digit, index) => 
        digit === actualPinArray[index]
      );
      
      if (isCorrect) {
        // Successful authentication
        pinAuthenticated = true;
        // Store session with timestamp and admin type for cross-page access
        const sessionData = {
          timestamp: Date.now(),
          authenticated: true,
          sessionType: 'admin'
        };
        sessionStorage.setItem('pinSession', JSON.stringify(sessionData));
        
        // Clear lockout data on success
        localStorage.removeItem('pinLockoutEnd');
        localStorage.removeItem('pinAttemptCount');
        attemptCount = 0;
        
        if (lockoutTimer) {
          clearInterval(lockoutTimer);
          lockoutTimer = null;
        }
        
        // Update activity time and start session monitoring
        updateLastActivity();
        
        pinOverlay.classList.add('hidden');
        
        // Initialize notifications after successful authentication
        setTimeout(() => {
          initializeNotifications();
          startApplicationMonitoring();
          
          // Show install button if PWA can be installed
          checkAndShowInstallButton();
          if (deferredPrompt && !isInstalled) {
            document.getElementById('install-btn').classList.add('show');
          }
        }, 1000);
      } else {
        // Failed authentication
        attemptCount++;
        localStorage.setItem('pinAttemptCount', attemptCount.toString());
        
        if (attemptCount >= maxAttempts) {
          // Start lockout
          startLockout();
        } else {
          // Show remaining attempts
          const remainingAttempts = maxAttempts - attemptCount;
          showPinError(`Invalid PIN. ${remainingAttempts} attempts remaining.`);
          clearPinInputs();
          setTimeout(() => {
            pinDigits[0].focus();
            
            // Force keyboard to open on mobile devices
            if (window.innerWidth <= 768 || /iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
              pinDigits[0].click();
              setTimeout(() => {
                pinDigits[0].focus();
              }, 100);
            }
          }, 500);
        }
      }
    }
    
    function startLockout() {
      const lockoutEnd = Date.now() + lockoutDuration;
      localStorage.setItem('pinLockoutEnd', lockoutEnd.toString());
      localStorage.setItem('pinAttemptCount', attemptCount.toString());
      
      // Disable all inputs
      pinDigits.forEach(digit => digit.disabled = true);
      
      startLockoutTimer(lockoutEnd);
    }
    
    function startLockoutTimer(lockoutEnd) {
      function updateLockoutDisplay() {
        const now = Date.now();
        const remaining = lockoutEnd - now;
        
        if (remaining <= 0) {
          // Lockout expired
          clearInterval(lockoutTimer);
          localStorage.removeItem('pinLockoutEnd');
          localStorage.removeItem('pinAttemptCount');
          attemptCount = 0;
          
          // Re-enable inputs
          pinDigits.forEach(digit => digit.disabled = false);
          clearPinInputs();
          pinError.textContent = 'Lockout expired. You may try again.';
          
          setTimeout(() => {
            clearPinError();
            pinDigits[0].focus();
            
            // Force keyboard to open on mobile devices
            if (window.innerWidth <= 768 || /iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
              pinDigits[0].click();
              setTimeout(() => {
                pinDigits[0].focus();
              }, 100);
            }
          }, 2000);
          
          return;
        }
        
        // Calculate time remaining
        const minutes = Math.floor(remaining / (1000 * 60));
        const seconds = Math.floor((remaining % (1000 * 60)) / 1000);
        
        showPinError(`Locked out. Try again in ${minutes}m ${seconds}s`);
      }
      
      // Update immediately and then every second
      updateLockoutDisplay();
      lockoutTimer = setInterval(updateLockoutDisplay, 1000);
    }
    
    function showPinError(message) {
      pinError.textContent = message;
      pinDigits.forEach(digit => {
        digit.classList.add('error');
      });
      setTimeout(() => {
        pinDigits.forEach(digit => {
          digit.classList.remove('error');
        });
      }, 500);
    }
    
    function clearPinError() {
      pinError.textContent = '';
      pinDigits.forEach(digit => {
        digit.classList.remove('error');
      });
    }
    
    function clearPinInputs() {
      pinDigits.forEach(digit => {
        digit.value = '';
        digit.classList.remove('filled');
      });
    }
    
    function navigateToPage(url) {
      if (!pinAuthenticated) {
        showPinError('Authentication required');
        return;
      }
      
      // Refresh session timestamp before navigation and maintain admin session type
      const sessionData = {
        timestamp: Date.now(),
        authenticated: true,
        sessionType: 'admin'
      };
      sessionStorage.setItem('pinSession', JSON.stringify(sessionData));
      
      location.href = url;
    }
  </script>
</body>
</html>
