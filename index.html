<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="description" content="Rhythm Boduberu - Premier Traditional Maldivian Boduberu Music Group. Experience authentic Boduberu performances, traditional Maldivian music, and cultural entertainment. Contact us for bookings: 7576784 / 9128889">
    <meta name="keywords" content="Rhythm Boduberu, Boduberu, Traditional Maldivian Music, Boduberu music, Boduberu group, Maldivian cultural music, traditional music Maldives, Boduberu performances, Maldivian drums, cultural entertainment Maldives, Rhythm, bookings, performances, Beru">
    <meta name="author" content="Rhythm Boduberu">
    <title>Rhythm Boduberu - Premier Maldivian Boduberu Group</title>
    
    <!-- Performance optimizations: Resource hints -->
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <link rel="preconnect" href="https://w.soundcloud.com">
    <link rel="dns-prefetch" href="https://api.soundcloud.com">
    
    <!-- Critical CSS - moved to external file for better caching -->
    <link rel="stylesheet" href="styles.css">
    
    <!-- Preload critical fonts -->
    <link rel="preload" href="Fonts/Montserrat-Regular.ttf" as="font" type="font/ttf" crossorigin>
    <link rel="preload" href="Fonts/Montserrat-Bold.ttf" as="font" type="font/ttf" crossorigin>
    
    <!-- Preload critical images -->
    <link rel="preload" href="src/Rhytham Logo.webp" as="image">
    <link rel="preload" href="src/Logo_1.svg" as="image">
    <link rel="preload" href="src/Background.webp" as="image">
    <link rel="preload" href="src/Logo.png" as="image">
    
    <!-- Favicon and web app manifest -->
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" type="image/x-icon" href="favicons/favicon.ico">
    <link rel="icon" type="image/png" sizes="16x16" href="favicons/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="favicons/favicon.ico">
    <link rel="icon" type="image/png" sizes="192x192" href="favicons/icons-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="favicons/icons-512.png">
    <link rel="apple-touch-icon" sizes="180x180" href="favicons/apple-touch-icon.png">
    <link rel="shortcut icon" href="favicons/favicon.ico">
    <link rel="manifest" href="favicons/manifest.webmanifest">
    
    <!-- Additional meta tags for better SEO and social sharing -->
    <meta name="theme-color" content="#f5d000">
    <meta name="msapplication-TileColor" content="#f5d000">
    <meta name="msapplication-TileImage" content="favicons/favicon.png">
    <meta property="og:title" content="Rhythm Boduberu - Premier Traditional Maldivian Boduberu Music Group">
    <meta property="og:description" content="Experience authentic Boduberu performances with Rhythm Boduberu - Maldives' premier traditional Boduberu music group. Book us for cultural events and traditional music performances.">
    <meta property="og:image" content="https://rhythmboduberu.com/favicons/favicon.png">
    <meta property="og:url" content="https://rhythmboduberu.com">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="Rhythm Boduberu">
    
    <!-- Twitter Card meta tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Rhythm Boduberu - Premier Traditional Maldivian Boduberu Music Group">
    <meta name="twitter:description" content="Experience authentic Boduberu performances with Rhythm Boduberu - Maldives' premier traditional Boduberu music group.">
    <meta name="twitter:image" content="https://rhythmboduberu.com/favicons/favicon.png">
    
    <!-- Canonical URL -->
    <link rel="canonical" href="https://rhythmboduberu.com">
    
    <!-- Additional SEO meta tags for Boduberu searches -->
    <meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1">
    <meta name="googlebot" content="index, follow">
    <meta name="bingbot" content="index, follow">
    <meta name="language" content="en">
    <meta name="geo.region" content="MV">
    <meta name="geo.country" content="Maldives">
    <meta name="geo.placename" content="Maldives">
    <meta name="ICBM" content="3.2028, 73.2207">
    
    <!-- Alternative titles for search engines -->
    <meta property="og:title" content="Rhythm Boduberu - Premier Traditional Maldivian Boduberu Music Group" />
    <meta name="twitter:title" content="Rhythm Boduberu - Premier Traditional Maldivian Boduberu Music Group" />
    <meta property="article:tag" content="Boduberu" />
    <meta property="article:tag" content="Traditional Maldivian Music" />
    <meta property="article:tag" content="Rhythm Boduberu" />
    <meta property="article:tag" content="Maldivian Culture" />
    
    <!-- Optimized script loading -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" defer></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/owl.carousel.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/owl.theme.default.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/owl.carousel.min.js" defer></script>
    
    <!-- JSON-LD structured data for better Google understanding -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "MusicGroup",
      "name": "Rhythm Boduberu",
      "description": "Premier Traditional Maldivian Boduberu Music Group - Experience authentic Boduberu performances and traditional Maldivian cultural music",
      "url": "https://rhythmboduberu.com",
      "logo": "https://rhythmboduberu.com/favicons/favicon.png",
      "image": [
        "https://rhythmboduberu.com/favicons/favicon.png"
      ],
      "telephone": "+9607576784",
      "alternateName": ["Rhythm", "Boduberu", "Rhythm Boduberu Group"],
      "genre": ["Traditional Maldivian Music", "Boduberu", "Cultural Music"],
      "keywords": "Boduberu, Traditional Maldivian Music, Boduberu music, Maldivian cultural music, Rhythm Boduberu",
      "areaServed": "Maldives",
      "foundingLocation": "Maldives",
      "sameAs": [
        "https://www.facebook.com/share/15pXtBHaRS/",
        "https://www.instagram.com/rhythm_boduberu__",
        "https://www.tiktok.com/@rhythm_boduberu_",
        "https://on.soundcloud.com/m60NOOoeFiEVGq1dTw",
        "https://www.youtube.com/@rhythmboduberu"
      ],
      "offers": {
        "@type": "Service",
        "name": "Boduberu Performances",
        "description": "Traditional Maldivian Boduberu music performances for cultural events and entertainment"
      }
    }
    </script>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loading-screen">
        <!-- Animated Pattern Background -->
        <div class="pattern-container" id="pattern-container">
            <!-- Pattern lines will be generated by JavaScript -->
        </div>
        <img src="src/Logo_1.svg" alt="Rhythm Boduberu Loading" class="loading-logo">
    </div>
    
    <section class="main-section">
        <div class="video-fallback"></div>
        <video class="video-background" autoplay muted loop playsinline>
            <source src="src/bg-video.mp4" type="video/mp4">
            Your browser does not support the video tag.
        </video>
        <div class="background-overlay"></div>
        
        <div class="image-container">
            <img src="src/Rhytham Logo.webp" alt="Rhythm Boduberu">
        </div>
        <div class="container">
            <a href="https://www.facebook.com/share/15pXtBHaRS/?mibextid=wwXIfr" target="_blank" class="link-button" aria-label="Visit Example Link 1">
                <img src="src/Facebook.png" alt="Facebook">
            </a>
            <a href="https://www.instagram.com/rhythm_boduberu__?igsh=MTc2dHdhbmk3cGxhbQ%3D%3D&utm_source=qr" target="_blank" class="link-button" aria-label="Visit Example Link 2">
                <img src="src/Instagram.png" alt="Instagram">
            </a>
            <a href="https://www.tiktok.com/@rhythm_boduberu_?_t=ZS-8t3wWH3Rura&_r=1" target="_blank" class="link-button" aria-label="Visit Example Link 3">
                <img src="src/Tiktok.png" alt="Tiktok">
            </a>
            <a href="https://on.soundcloud.com/m60NOOoeFiEVGq1dTw" target="_blank" class="link-button" aria-label="Visit Example Link 4">
                <img src="src/Soundcloud.png" alt="Soundcloud">
            </a>
            <a href="https://www.youtube.com/@rhythmboduberu" target="_blank" class="link-button" aria-label="Visit Example Link 5">
                <img src="src/Youtube.png" alt="Youtube">
            </a>
        </div>
        <div class="container2">
            <a href="https://invite.viber.com/?g2=AQBr7RgqaOJOp1SaLAlHeZH%2BrPk4S3rwDdiOGwLstgf9PWiKNB9kWaZS3SSn%2Bw1o" class="link-button2" aria-label="Join Our Viber Community">
                <img src="src/Viber.png" alt="Join Our Viber Community">
            </a>
            <a href="tel:+9607576784" class="link-button2" aria-label="Call Now">
                <img src="src/Call.png" alt="Call Now">
            </a>
        </div>
        <footer>
             Rhythm Boduberu <a href="https://rhythmboduberu.com" target="_blank">- Phone: 7576784 / 9128889</a>
        </footer>
    </section>

    <!-- Section Two - Listen to Our Music -->
    <section class="music-section">
        <div class="section-header">
            <h2>LISTEN TO OUR MUSIC</h2>
        </div>
        
        <div class="music-tiles-container">
            <!-- Custom Navigation Arrows -->
            <button class="carousel-nav prev" id="carousel-prev" aria-label="Previous track">
                <svg viewBox="0 0 24 24">
                    <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/>
                </svg>
            </button>
            <button class="carousel-nav next" id="carousel-next" aria-label="Next track">
                <svg viewBox="0 0 24 24">
                    <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
                </svg>
            </button>
            
            <!-- Owl Carousel for infinite music tiles -->
            <div class="owl-carousel owl-theme" id="music-carousel">
                <!-- Tiles will be dynamically generated from music-data.js -->
            </div>
        </div>
        
        <!-- Tile Indicators (will be dynamically generated) -->
        <div class="tile-indicators" id="tile-indicators">
            <!-- Dots will be dynamically generated from music-data.js -->
        </div>
        
        <!-- Debug button for testing -->
        <div style="text-align: center; margin-top: 20px;">
            <!-- Debug tools removed for Owl Carousel -->
        </div>
    </section>

    <!-- Add your additional content sections below this line -->

    <script src="https://w.soundcloud.com/player/api.js" defer></script>
    <script src="music-data.js" defer></script>
    <script src="music-player.js" defer></script>
    <script>
        // Video fallback handling - optimized
        document.addEventListener('DOMContentLoaded', function() {
            const video = document.querySelector('.video-background');
            const fallback = document.querySelector('.video-fallback');
            
            if (video) {
                video.addEventListener('error', function() {
                    video.style.display = 'none';
                    if (fallback) fallback.style.display = 'block';
                });
                
                video.addEventListener('loadeddata', function() {
                    if (fallback) fallback.style.display = 'none';
                });
            }
        });
    </script>
</body>
</html>
    <script>
        // Video fallback handling
        const video = document.querySelector('.video-background');
        const fallback = document.querySelector('.video-fallback');
        
        video.addEventListener('error', function() {
            // If video fails to load, show fallback background
            video.style.display = 'none';
            fallback.style.display = 'block';
        });
        
        video.addEventListener('loadeddata', function() {
            // If video loads successfully, hide fallback background
            fallback.style.display = 'none';
        });

        // Custom music player functionality
        let currentlyPlaying = null;
        let currentWidget = null;
        let playStates = {}; // Store play states for each player
        let savedPositions = {}; // Store saved positions for each track
        let currentActiveIndex = 0; // Track which tile is currently active
        let currentDotIndex = 0; // Start with first dot active (will be updated when dots are generated)
        let totalDots = 0; // Track total number of dots
        let isVideoPlaying = true; // Track video state
        let lastSwipeDirection = null; // Track the last user swipe direction
        
        // Touch/swipe detection variables
        let startX = 0;
        let startY = 0;
        let endX = 0;
        let endY = 0;
        
        // Enhanced dot indicator management with smooth animations
        function updateDots(direction, animate = true) {
            const dots = document.querySelectorAll('.indicator-dot');
            if (dots.length === 0) return; // No dots to update
            
            // Determine dot movement based on user swipe direction
            let dotDirection = direction;
            if (lastSwipeDirection) {
                // Move dot opposite to user swipe direction
                dotDirection = lastSwipeDirection === 'right' ? 'left' : 'right';
                console.log('User swiped:', lastSwipeDirection, '- Moving dot:', dotDirection);
            }
            
            if (animate) {
                // Add transition classes for smooth animation
                dots.forEach((dot, index) => {
                    dot.classList.remove('active', 'next-active', 'prev-active');
                    
                    // Calculate relative position to current active dot
                    const distance = index - currentDotIndex;
                    
                    if (distance === 0) {
                        dot.classList.add('active');
                    } else if (distance === 1 || distance === -(totalDots - 1)) { // Next dot (accounting for wrap-around)
                        dot.classList.add('next-active');
                    } else if (distance === -1 || distance === (totalDots - 1)) { // Previous dot (accounting for wrap-around)
                        dot.classList.add('prev-active');
                    }
                });
                
                // Animate the transition
                setTimeout(() => {
                    // Update dot index based on determined direction
                    if (dotDirection === 'left') { // Move dot left
                        currentDotIndex = (currentDotIndex - 1 + totalDots) % totalDots;
                    } else if (dotDirection === 'right') { // Move dot right
                        currentDotIndex = (currentDotIndex + 1) % totalDots;
                    }
                    
                    // Apply new states
                    dots.forEach((dot, index) => {
                        dot.classList.remove('active', 'next-active', 'prev-active');
                        
                        const distance = index - currentDotIndex;
                        
                        if (distance === 0) {
                            dot.classList.add('active');
                        } else if (distance === 1 || distance === -(totalDots - 1)) {
                            dot.classList.add('next-active');
                        } else if (distance === -1 || distance === (totalDots - 1)) {
                            dot.classList.add('prev-active');
                        }
                    });
                    
                    // Clear the last swipe direction after using it
                    lastSwipeDirection = null;
                }, 100);
            } else {
                // Immediate update without animation
                if (dotDirection === 'left') { // Move dot left
                    currentDotIndex = (currentDotIndex - 1 + totalDots) % totalDots;
                } else if (dotDirection === 'right') { // Move dot right
                    currentDotIndex = (currentDotIndex + 1) % totalDots;
                }
                
                dots.forEach((dot, index) => {
                    dot.classList.remove('active', 'next-active', 'prev-active');
                    
                    const distance = index - currentDotIndex;
                    
                    if (distance === 0) {
                        dot.classList.add('active');
                    } else if (distance === 1 || distance === -(totalDots - 1)) {
                        dot.classList.add('next-active');
                    } else if (distance === -1 || distance === (totalDots - 1)) {
                        dot.classList.add('prev-active');
                    }
                });
                
                // Clear the last swipe direction after using it
                lastSwipeDirection = null;
            }
        }
        
        // Video control functions
        function pauseVideo() {
            const video = document.querySelector('.video-background');
            if (video && !video.paused && isVideoPlaying) {
                video.pause();
                isVideoPlaying = false;
                console.log('Video paused to save resources');
            }
        }
        
        function resumeVideo() {
            const video = document.querySelector('.video-background');
            if (video && video.paused && !isVideoPlaying) {
                video.play().catch(() => {
                    // Handle autoplay restrictions
                    console.log('Video autoplay prevented');
                });
                isVideoPlaying = true;
                console.log('Video resumed');
            }
        }
        
        // Lazy loading for thumbnails
        function preloadThumbnails() {
            if (typeof musicData === 'undefined') return;
            
            // Get currently visible tiles
            const visibleTiles = document.querySelectorAll('.owl-item.active .track-thumbnail, .music-tile .track-thumbnail');
            const visibleSrcs = Array.from(visibleTiles).map(img => img.src);
            
            // Preload thumbnails that aren't currently visible
            musicData.forEach(track => {
                if (!visibleSrcs.includes(track.thumbnailUrl)) {
                    const img = new Image();
                    img.src = track.thumbnailUrl;
                    // Optional: add to cache or handle load events
                    img.onload = () => {
                        console.log('Preloaded thumbnail:', track.title);
                    };
                }
            });
        }
        
        // Enhanced scroll detection for immediate video restart
        let lastScrollPosition = 0;
        function handleScroll() {
            const scrollPosition = window.scrollY;
            const windowHeight = window.innerHeight;
            const documentHeight = document.documentElement.scrollHeight;
            
            // Check if we're at the bottom of the page
            const isAtBottom = scrollPosition + windowHeight >= documentHeight - 50; // Reduced threshold for earlier detection
            
            // Restart video immediately if:
            // 1. Not at bottom AND video is paused AND no music is playing
            if (!isAtBottom && !isVideoPlaying && !currentlyPlaying) {
                console.log('Not at bottom - restarting video immediately');
                resumeVideo();
            }
            // Pause video only when actually at bottom
            else if (isAtBottom && isVideoPlaying) {
                console.log('At bottom - pausing video');
                pauseVideo();
            }
            
            // Update last scroll position for future reference
            lastScrollPosition = scrollPosition;
        }
        
        // Function to generate indicator dots based on music data
        function generateIndicatorDots() {
            if (typeof musicData === 'undefined') {
                console.error('musicData not available for generating dots');
                return;
            }
            
            const indicatorsContainer = document.getElementById('tile-indicators');
            if (!indicatorsContainer) {
                console.error('Indicators container not found');
                return;
            }
            
            // Clear existing dots
            indicatorsContainer.innerHTML = '';
            
            // Set total dots count
            totalDots = musicData.length;
            
            // Generate dots for each track
            musicData.forEach((track, index) => {
                const dot = document.createElement('div');
                dot.className = 'indicator-dot';
                dot.setAttribute('data-index', index);
                
                // First dot starts as active
                if (index === 0) {
                    dot.classList.add('active');
                    currentDotIndex = 0;
                }
                
                indicatorsContainer.appendChild(dot);
            });
            
            console.log('Generated', totalDots, 'indicator dots');
        }
        function generateSoundCloudUrl(trackId) {
            const baseUrl = "https://w.soundcloud.com/player/";
            const params = new URLSearchParams({
                url: `https://api.soundcloud.com/tracks/${trackId}`,
                color: "#000000",
                auto_play: "true",
                hide_related: "true",
                show_comments: "false",
                show_user: "false",
                show_reposts: "false",
                show_teaser: "false",
                visual: "false",
                buying: "false",
                sharing: "false",
                download: "false",
                start_track: "0",
                single_active: "true"
            });
            
            return baseUrl + "?" + params.toString();
        }
        
        // Function to generate a music tile from data
        function createMusicTile(track) {
            const formLine = track.form ? `<p class="tile-form">${track.form}</p>` : '';
            const originalTag = track.original ? `<p class="tile-original">Original</p>` : '';
            const soundcloudUrl = generateSoundCloudUrl(track.trackId);
            
            return `
                <div class="music-tile" data-track-id="${track.id}">
                    <div class="custom-player">
                        <img class="track-thumbnail" src="${track.thumbnailUrl}" alt="${track.title}" loading="lazy">
                        <div class="custom-play-overlay">
                            <button class="custom-play-btn" data-iframe-src="${soundcloudUrl}">
                                <svg class="play-icon" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M8 5v14l11-7z"/>
                                </svg>
                                <svg class="pause-icon" viewBox="0 0 24 24" fill="currentColor" style="display: none;">
                                    <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>
                                </svg>
                            </button>
                        </div>
                        <div class="soundcloud-player" style="display: none;">
                            <iframe 
                                src=""
                                allow="autoplay"
                                loading="lazy">
                            </iframe>
                        </div>
                        <div class="tile-info-banner">
                            ${originalTag}
                            <h3 class="tile-title">${track.title}</h3>
                            <p class="tile-artist">${track.artist}</p>
                            ${formLine}
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Function to populate carousel with music tiles
        function populateCarousel() {
            console.log('=== POPULATING CAROUSEL FROM MUSIC DATA ===');
            
            const carousel = document.getElementById('music-carousel');
            if (!carousel) {
                console.error('Carousel element not found');
                return;
            }
            
            // Check if musicData is available
            if (typeof musicData === 'undefined') {
                console.error('musicData not loaded');
                return;
            }
            
            console.log('Music data loaded:', musicData.length, 'tracks');
            console.log('First track data:', musicData[0]);
            
            // Generate indicator dots first
            generateIndicatorDots();
            
            // Clear existing content
            carousel.innerHTML = '';
            
            // Generate tiles from music data
            musicData.forEach((track, index) => {
                console.log(`Generating tile ${index + 1}:`, track.title);
                const tileHTML = createMusicTile(track);
                carousel.innerHTML += tileHTML;
            });
            
            console.log('Generated', musicData.length, 'tiles from music data');
            
            // Verify buttons were created
            setTimeout(() => {
                const buttons = carousel.querySelectorAll('.custom-play-btn');
                console.log('Play buttons created:', buttons.length);
                buttons.forEach((btn, i) => {
                    const src = btn.getAttribute('data-iframe-src');
                    console.log(`Button ${i + 1} iframe src:`, src ? 'Set' : 'Missing');
                });
            }, 100);
        }
        
        function initializeCarousel() {
            console.log('=== INITIALIZING OWL CAROUSEL ===');
            
            // First, populate the carousel with music data
            populateCarousel();
            
            // Check if jQuery and Owl Carousel are loaded
            if (typeof jQuery === 'undefined') {
                console.error('jQuery is not loaded!');
                showFallbackCarousel();
                return;
            }
            
            if (typeof jQuery().owlCarousel === 'undefined') {
                console.error('Owl Carousel is not loaded!');
                showFallbackCarousel();
                return;
            }
            
            // Check if elements exist
            const carouselElement = $('#music-carousel');
            console.log('Carousel element found:', carouselElement.length);
            console.log('Number of tiles:', carouselElement.find('.music-tile').length);
            
            if (carouselElement.length === 0) {
                console.error('Carousel element not found!');
                return;
            }
            
            // Initialize Owl Carousel
            try {
                $('#music-carousel').owlCarousel({
                    items: 3,
                    loop: true,
                    center: true,
                    margin: 20,
                    nav: false,
                    dots: false,
                    autoplay: false,
                    mouseDrag: true,
                    touchDrag: true,
                    pullDrag: true,
                    freeDrag: false,
                    stagePadding: 0,
                    smartSpeed: 500,
                    startPosition: 0,
                    autoWidth: false, // Ensure consistent item widths
                    responsive: {
                        0: {
                            items: 1,
                            margin: 10,
                            stagePadding: 0,
                            center: true,
                            autoWidth: false
                        },
                        768: {
                            items: 2,
                            margin: 15,
                            stagePadding: 0,
                            center: true,
                            autoWidth: false
                        },
                        1024: {
                            items: 3,
                            margin: 20,
                            stagePadding: 0,
                            center: true,
                            autoWidth: false
                        }
                    },
                    onInitialized: function(event) {
                        console.log('Owl Carousel initialized successfully');
                        // Reattach event listeners after initialization
                        setTimeout(() => {
                            attachEventListeners();
                            const $carousel = $('#music-carousel');
                            $carousel.trigger('refresh.owl.carousel');
                            $carousel.trigger('to.owl.carousel', [0, 0]);
                        }, 200);
                    },
                    onInitialize: function(event) {
                        console.log('Owl Carousel initializing...');
                    },
                    onChanged: function(event) {
                        // Ensure center item is properly highlighted and reattach event listeners
                        setTimeout(() => {
                            attachEventListeners(); // Reattach listeners after slide change
                            $('.music-tile').removeClass('center-item');
                            $('.owl-item.center .music-tile').addClass('center-item');
                        }, 100);
                        
                        // Update dots based on carousel movement - will use lastSwipeDirection if available
                        updateDots('carousel-changed', true);
                        
                        // Preload thumbnails after carousel change
                        setTimeout(preloadThumbnails, 500);
                    }
                });
            } catch (error) {
                console.error('Error initializing Owl Carousel:', error);
                showFallbackCarousel();
                return;
            }
            
            // Attach event listeners to all play buttons
            attachEventListeners();
            
            // Attach navigation arrow event listeners
            attachNavigationListeners();
            
            console.log('=== OWL CAROUSEL INITIALIZATION COMPLETE ===');
        }
        
        function showFallbackCarousel() {
            console.log('Showing fallback carousel...');
            
            // First populate with music data if not already done
            populateCarousel();
            
            // Show tiles in a simple horizontal layout
            const carousel = document.getElementById('music-carousel');
            if (carousel) {
                carousel.style.display = 'flex';
                carousel.style.flexWrap = 'nowrap';
                carousel.style.overflowX = 'auto';
                carousel.style.gap = '20px';
                carousel.style.padding = '20px';
                
                // Make sure all tiles are visible
                const tiles = carousel.querySelectorAll('.music-tile');
                tiles.forEach(tile => {
                    tile.style.display = 'block';
                    tile.style.minWidth = '300px';
                    tile.style.flexShrink = '0';
                });
                
                // Attach event listeners since Owl Carousel won't do it
                attachEventListeners();
                attachNavigationListeners();
                
                console.log('Fallback carousel activated with', tiles.length, 'tiles');
            }
        }
        
        function attachNavigationListeners() {
            // Attach navigation arrow listeners
            const prevButton = document.getElementById('carousel-prev');
            const nextButton = document.getElementById('carousel-next');
            
            if (prevButton) {
                prevButton.removeEventListener('click', scrollToPrev);
                prevButton.addEventListener('click', scrollToPrev);
            }
            
            if (nextButton) {
                nextButton.removeEventListener('click', scrollToNext);
                nextButton.addEventListener('click', scrollToNext);
            }
            
            console.log('Navigation listeners attached');
        }
        
        function scrollToNext() {
            if (typeof jQuery !== 'undefined' && $('#music-carousel').data('owl.carousel')) {
                lastSwipeDirection = 'right'; // Simulate right swipe for next
                $('#music-carousel').trigger('next.owl.carousel');
            } else {
                // Fallback for manual carousel
                const carousel = document.getElementById('music-carousel');
                if (carousel) {
                    carousel.scrollBy({ left: 320, behavior: 'smooth' });
                }
                updateDots('right', false); // Next = move right through dots
            }
        }
        
        function scrollToPrev() {
            if (typeof jQuery !== 'undefined' && $('#music-carousel').data('owl.carousel')) {
                lastSwipeDirection = 'left'; // Simulate left swipe for prev
                $('#music-carousel').trigger('prev.owl.carousel');
            } else {
                // Fallback for manual carousel
                const carousel = document.getElementById('music-carousel');
                if (carousel) {
                    carousel.scrollBy({ left: -320, behavior: 'smooth' });
                }
                updateDots('left', false); // Prev = move left through dots
            }
        }
        
        function attachEventListeners() {
            // Remove existing event delegation listener if any
            const carousel = document.getElementById('music-carousel');
            if (carousel) {
                // Use event delegation to handle clicks on any play button
                carousel.removeEventListener('click', handleCarouselClick);
                carousel.addEventListener('click', handleCarouselClick);
                console.log('Event delegation attached to carousel');
            }
            
            // Also attach to all current play buttons for immediate functionality
            const customButtons = document.querySelectorAll('.music-tile .custom-play-btn');
            console.log('Attaching listeners to', customButtons.length, 'buttons');
            
            customButtons.forEach((button, index) => {
                // Remove existing listeners to prevent duplicates
                button.removeEventListener('click', handlePlayButtonClick);
                button.addEventListener('click', handlePlayButtonClick);
                console.log(`Attached listener to button ${index + 1}`);
            });
        }
        
        function handleCarouselClick(e) {
            // Check if the clicked element is a play button or inside one
            const playButton = e.target.closest('.custom-play-btn');
            if (playButton) {
                e.preventDefault();
                const iframeSrc = playButton.getAttribute('data-iframe-src');
                console.log('Play button clicked via delegation, iframe src:', iframeSrc);
                togglePlay(playButton, iframeSrc);
            }
        }
        
        function handlePlayButtonClick(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('=== PLAY BUTTON CLICKED ===');
            const button = e.currentTarget;
            const iframeSrc = button.getAttribute('data-iframe-src');
            console.log('Play button clicked directly, iframe src:', iframeSrc);
            console.log('Button element:', button);
            console.log('Current widget:', currentWidget);
            console.log('Currently playing:', currentlyPlaying);
            togglePlay(button, iframeSrc);
        }
        
        // Load saved positions from localStorage
        function loadSavedPositions() {
            const saved = localStorage.getItem('rhythmBoduberuPositions');
            if (saved) {
                try {
                    savedPositions = JSON.parse(saved);
                    console.log('Loaded saved positions:', savedPositions);
                } catch (e) {
                    console.error('Error loading saved positions:', e);
                    savedPositions = {};
                }
            } else {
                console.log('No saved positions found');
            }
        }
        
        // Save positions to localStorage
        function savePositions() {
            localStorage.setItem('rhythmBoduberuPositions', JSON.stringify(savedPositions));
            console.log('Saved positions to localStorage:', savedPositions);
        }
        
        // Get track ID from iframe src
        function getTrackId(iframeSrc) {
            // Try different URL patterns for SoundCloud
            let match = iframeSrc.match(/tracks\/(\d+)/);
            if (!match) {
                // Try URL-encoded pattern (most common in SoundCloud widget URLs)
                match = iframeSrc.match(/tracks%2F(\d+)/);
            }
            if (!match) {
                // Try the pattern in the actual URL structure
                match = iframeSrc.match(/api\.soundcloud\.com%2Ftracks%2F(\d+)/);
            }
            if (!match) {
                // Try without URL encoding
                match = iframeSrc.match(/api\.soundcloud\.com\/tracks\/(\d+)/);
            }
            if (!match) {
                // Try direct track ID pattern
                match = iframeSrc.match(/\/(\d+)&/);
            }
            const trackId = match ? match[1] : null;
            console.log('Extracted track ID:', trackId, 'from URL:', iframeSrc);
            return trackId;
        }

        function togglePlay(button, iframeSrc) {
            console.log('=== TOGGLE PLAY CALLED ===');
            console.log('Button:', button);
            console.log('Iframe src:', iframeSrc);
            
            if (!button) {
                console.error('Button is null or undefined');
                return;
            }
            
            if (!iframeSrc) {
                console.error('Iframe src is null or undefined');
                return;
            }
            
            const overlay = button.parentElement;
            const playerContainer = overlay.parentElement;
            const soundcloudPlayer = playerContainer.querySelector('.soundcloud-player');
            const iframe = soundcloudPlayer.querySelector('iframe');
            const playIcon = button.querySelector('.play-icon');
            const pauseIcon = button.querySelector('.pause-icon');
            const playerIndex = Array.from(document.querySelectorAll('.music-tile')).indexOf(playerContainer.closest('.music-tile'));

            console.log('Player container:', playerContainer);
            console.log('SoundCloud player:', soundcloudPlayer);
            console.log('Iframe:', iframe);
            console.log('Player index:', playerIndex);

            // If another player is playing, stop it
            if (currentlyPlaying && currentlyPlaying !== playerContainer) {
                console.log('Stopping currently playing player');
                stopPlayer(currentlyPlaying);
            }

            // Check if this player is currently active
            if (currentlyPlaying === playerContainer && currentWidget) {
                // Player is active, use widget controls directly
                console.log('Player active, using widget controls');
                
                if (playStates[playerIndex]) {
                    console.log('Currently playing, pausing...');
                    currentWidget.pause();
                    // Update UI immediately
                    playStates[playerIndex] = false;
                    if (playIcon) playIcon.style.display = 'block';
                    if (pauseIcon) pauseIcon.style.display = 'none';
                } else {
                    console.log('Currently paused, playing...');
                    currentWidget.play();
                    // Update UI immediately
                    playStates[playerIndex] = true;
                    if (playIcon) playIcon.style.display = 'none';
                    if (pauseIcon) pauseIcon.style.display = 'block';
                }
                return;
            }

            // Start new player
            startPlayer(playerContainer, iframe, iframeSrc, overlay, playerIndex);
        }

        function startPlayer(container, iframe, iframeSrc, overlay, playerIndex) {
            const trackId = getTrackId(iframeSrc);
            
            // Pause video when music starts playing
            pauseVideo();
            
            // Set the iframe source to start playing
            iframe.src = iframeSrc;
            
            // Show the player and adjust overlay for playing state
            container.querySelector('.soundcloud-player').style.display = 'block';
            overlay.classList.add('playing');
            
            // Slide up the banner
            const banner = container.querySelector('.tile-info-banner');
            banner.classList.add('playing');
            
            // Update play button style and position but keep it as play icon (not playing)
            const button = overlay.querySelector('.custom-play-btn');
            button.classList.add('playing');
            // Keep the play icon visible since we're not auto-playing
            button.querySelector('.play-icon').style.display = 'block';
            button.querySelector('.pause-icon').style.display = 'none';
            
            currentlyPlaying = container;

            // Initialize SoundCloud Widget API without auto-play
            iframe.onload = function() {
                console.log('Iframe loaded, checking SoundCloud API availability...');
                
                if (typeof SC === 'undefined' || !SC.Widget) {
                    console.error('SoundCloud Widget API not available');
                    return;
                }
                
                console.log('SoundCloud API available, creating widget...');
                currentWidget = SC.Widget(iframe);
                
                // Set up widget event listeners without auto-play
                currentWidget.bind(SC.Widget.Events.READY, function() {
                    console.log('SoundCloud widget ready for track:', trackId);
                    
                    // Check if there's a saved position for this track
                    if (trackId && savedPositions[trackId]) {
                        console.log('Seeking to saved position:', savedPositions[trackId], 'for track:', trackId);
                        
                        // Wait a bit for the track to be fully loaded before seeking
                        setTimeout(() => {
                            currentWidget.seekTo(savedPositions[trackId]);
                        }, 800);
                    } else {
                        console.log('No saved position found for track:', trackId);
                    }
                    
                    // Set initial state to paused (no auto-play)
                    playStates[playerIndex] = false;
                    button.querySelector('.play-icon').style.display = 'block';
                    button.querySelector('.pause-icon').style.display = 'none';
                });

                currentWidget.bind(SC.Widget.Events.PLAY, function() {
                    console.log('SoundCloud PLAY event fired for track:', trackId);
                    playStates[playerIndex] = true;
                    // Update button to show pause icon
                    button.querySelector('.play-icon').style.display = 'none';
                    button.querySelector('.pause-icon').style.display = 'block';
                });

                currentWidget.bind(SC.Widget.Events.PAUSE, function() {
                    console.log('SoundCloud PAUSE event fired for track:', trackId);
                    playStates[playerIndex] = false;
                    
                    // Save current position when paused
                    if (trackId && currentWidget) {
                        currentWidget.getPosition(function(position) {
                            console.log('Saving position:', position, 'for track:', trackId);
                            savedPositions[trackId] = position;
                            savePositions();
                        });
                    }
                    // Update button to show play icon
                    button.querySelector('.play-icon').style.display = 'block';
                    button.querySelector('.pause-icon').style.display = 'none';
                });

                currentWidget.bind(SC.Widget.Events.FINISH, function() {
                    playStates[playerIndex] = false;
                    // Clear saved position when track finishes
                    if (trackId) {
                        delete savedPositions[trackId];
                        savePositions();
                    }
                    stopPlayer(container);
                });

                // Periodically save position and sync button state
                const syncInterval = setInterval(() => {
                    if (currentWidget && currentlyPlaying === container) {
                        // Save position every 2 seconds while playing
                        if (playStates[playerIndex] && trackId) {
                            currentWidget.getPosition(function(position) {
                                console.log('Auto-saving position:', position, 'for track:', trackId);
                                savedPositions[trackId] = position;
                                savePositions();
                            });
                        }
                        
                        // Sync button state
                        currentWidget.isPaused(function(paused) {
                            const actuallyPlaying = !paused;
                            if (playStates[playerIndex] !== actuallyPlaying) {
                                playStates[playerIndex] = actuallyPlaying;
                                if (actuallyPlaying) {
                                    button.querySelector('.play-icon').style.display = 'none';
                                    button.querySelector('.pause-icon').style.display = 'block';
                                } else {
                                    button.querySelector('.play-icon').style.display = 'block';
                                    button.querySelector('.pause-icon').style.display = 'none';
                                }
                            }
                        });
                    } else {
                        clearInterval(syncInterval);
                    }
                }, 2000); // Check every 2 seconds for position saving and button sync
            };
        }

        function stopPlayer(container) {
            const overlay = container.querySelector('.custom-play-overlay');
            const iframe = container.querySelector('iframe');
            const playerIndex = Array.from(document.querySelectorAll('.music-tile')).indexOf(container.closest('.music-tile'));
            const iframeSrc = overlay.querySelector('.custom-play-btn').getAttribute('data-iframe-src');
            const trackId = getTrackId(iframeSrc);
            
            // Save current position before stopping if widget exists and is playing
            if (currentWidget && playStates[playerIndex] && trackId) {
                currentWidget.getPosition(function(position) {
                    savedPositions[trackId] = position;
                    savePositions();
                });
            }
            
            // Stop the widget if it exists
            if (currentWidget) {
                currentWidget.pause();
                playStates[playerIndex] = false;
            }
            
            // Stop the player by removing the src
            iframe.src = '';
            
            // Hide the player and reset overlay
            container.querySelector('.soundcloud-player').style.display = 'none';
            overlay.classList.remove('playing');
            
            // Slide down the banner
            const banner = container.querySelector('.tile-info-banner');
            banner.classList.remove('playing');
            
            // Reset play button style and position
            const button = overlay.querySelector('.custom-play-btn');
            button.classList.remove('playing');
            button.querySelector('.play-icon').style.display = 'block';
            button.querySelector('.pause-icon').style.display = 'none';
            
            if (currentlyPlaying === container) {
                currentlyPlaying = null;
                currentWidget = null;
                // Resume video when music stops (if not at bottom of page)
                const scrollPosition = window.scrollY;
                const windowHeight = window.innerHeight;
                const documentHeight = document.documentElement.scrollHeight;
                const isAtBottom = scrollPosition + windowHeight >= documentHeight - 100;
                
                if (!isAtBottom) {
                    resumeVideo();
                }
            }
        }

        // Function to handle custom button clicks when player is active
        function handleCustomButtonClick(button) {
            if (!currentWidget) return;
            
            const playerIndex = Array.from(document.querySelectorAll('.music-tile')).indexOf(
                button.closest('.music-tile')
            );
            
            if (playStates[playerIndex]) {
                currentWidget.pause();
            } else {
                currentWidget.play();
            }
        }

        // Add click handlers to all custom play buttons
        document.addEventListener('DOMContentLoaded', function() {
            console.log('=== DOM CONTENT LOADED EVENT FIRED ===');
            console.log('Document ready state:', document.readyState);
            
            // Load saved positions on page load
            loadSavedPositions();
            
            // Check for required dependencies
            function checkDependencies() {
                const hasJQuery = typeof jQuery !== 'undefined';
                const hasOwlCarousel = hasJQuery && typeof jQuery().owlCarousel !== 'undefined';
                const hasSoundCloudAPI = typeof SC !== 'undefined' && SC.Widget;
                const hasMusicData = typeof musicData !== 'undefined';
                
                console.log('Dependencies check:');
                console.log('- jQuery:', hasJQuery);
                console.log('- Owl Carousel:', hasOwlCarousel);
                console.log('- SoundCloud API:', hasSoundCloudAPI);
                console.log('- Music Data:', hasMusicData);
                
                return { hasJQuery, hasOwlCarousel, hasSoundCloudAPI, hasMusicData };
            }
            
            // Wait for jQuery and Owl Carousel to be ready
            $(document).ready(function() {
                console.log('jQuery ready, checking all dependencies...');
                
                const deps = checkDependencies();
                if (!deps.hasMusicData) {
                    console.error('Music data not loaded, retrying in 1 second...');
                    setTimeout(() => {
                        initializeCarousel();
                    }, 1000);
                    return;
                }
                
                console.log('All dependencies ready, initializing Owl Carousel...');
                // Initialize the Owl Carousel
                initializeCarousel();
                
                // Fallback timeout - if carousel isn't visible after 3 seconds, show fallback
                setTimeout(() => {
                    const carousel = document.getElementById('music-carousel');
                    const isVisible = carousel && carousel.offsetHeight > 0;
                    if (!isVisible) {
                        console.log('Carousel not visible after 3 seconds, showing fallback');
                        showFallbackCarousel();
                    }
                }, 3000);
            });
            
            // Add keyboard navigation
            document.addEventListener('keydown', function(event) {
                if (event.key === 'ArrowLeft') {
                    event.preventDefault();
                    scrollToPrev();
                } else if (event.key === 'ArrowRight') {
                    event.preventDefault();
                    scrollToNext();
                }
            });
            
            // Add scroll listener for immediate video restart
            window.addEventListener('scroll', function() {
                // Call handleScroll immediately without debouncing for instant video restart
                handleScroll();
            });
            
            // Initial thumbnail preload after carousel loads
            setTimeout(() => {
                preloadThumbnails();
            }, 2000);
            
            // Prevent vertical scrolling when interacting with carousel on mobile
            const carouselContainer = document.querySelector('.music-tiles-container');
            if (carouselContainer) {
                let isCarouselTouch = false;
                
                carouselContainer.addEventListener('touchstart', function(e) {
                    isCarouselTouch = true;
                    // Capture start position for swipe detection
                    const touch = e.touches[0];
                    startX = touch.clientX;
                    startY = touch.clientY;
                }, { passive: true });
                
                carouselContainer.addEventListener('touchmove', function(e) {
                    if (isCarouselTouch) {
                        // Allow horizontal movement, prevent vertical
                        const touch = e.touches[0];
                        const currentX = touch.clientX;
                        const currentY = touch.clientY;
                        
                        // Store initial touch position
                        if (!this.initialTouch) {
                            this.initialTouch = { x: startX, y: startY };
                        }
                        
                        const deltaX = Math.abs(currentX - this.initialTouch.x);
                        const deltaY = Math.abs(currentY - this.initialTouch.y);
                        
                        // If horizontal movement is greater than vertical, prevent page scroll
                        if (deltaX > deltaY) {
                            e.preventDefault();
                        }
                    }
                }, { passive: false });
                
                carouselContainer.addEventListener('touchend', function(e) {
                    if (isCarouselTouch) {
                        // Capture end position and determine swipe direction
                        const touch = e.changedTouches[0];
                        endX = touch.clientX;
                        endY = touch.clientY;
                        
                        // Calculate swipe direction
                        const deltaX = endX - startX;
                        const deltaY = endY - startY;
                        
                        // Only consider horizontal swipes (ignore vertical)
                        if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > 30) {
                            if (deltaX > 0) {
                                lastSwipeDirection = 'right'; // Swiped right
                                console.log('Detected right swipe');
                            } else {
                                lastSwipeDirection = 'left'; // Swiped left
                                console.log('Detected left swipe');
                            }
                        }
                    }
                    
                    isCarouselTouch = false;
                    this.initialTouch = null;
                    
                    // Preload thumbnails after touch interaction
                    setTimeout(preloadThumbnails, 300);
                }, { passive: true });
            }
        });
        
        // Prevent pinch to zoom
        document.addEventListener('touchstart', function(event) {
            if (event.touches.length > 1) {
                event.preventDefault();
            }
        }, { passive: false });

        document.addEventListener('touchmove', function(event) {
            if (event.scale && event.scale !== 1) {
                event.preventDefault();
            }
        }, { passive: false });

        // Prevent zoom via keyboard shortcuts
        document.addEventListener('keydown', function(event) {
            if ((event.ctrlKey || event.metaKey) && (event.key === '+' || event.key === '-' || event.key === '0')) {
                event.preventDefault();
            }
        });
        
        // Loading screen functionality
        window.addEventListener('load', function() {
            const loadingScreen = document.getElementById('loading-screen');
            const patternContainer = document.getElementById('pattern-container');
            
            // Generate animated pattern lines - Optimized
            function generatePatternLines() {
                if (!patternContainer) return;
                
                // Calculate how many lines needed to fill the screen (optimized for performance)
                const viewportHeight = window.innerHeight;
                const lineHeight = 40;
                const numberOfLines = Math.ceil(viewportHeight / lineHeight) + 1; // Reduced extra lines from 2 to 1
                
                // Clear any existing lines
                patternContainer.innerHTML = '';
                
                // Create pattern lines with performance optimizations
                for (let i = 0; i < numberOfLines; i++) {
                    const line = document.createElement('div');
                    line.className = 'pattern-line';
                    line.style.top = (i * lineHeight) + 'px';
                    // Add performance optimizations
                    line.style.willChange = 'transform';
                    line.style.transform = 'translateZ(0)';
                    patternContainer.appendChild(line);
                }
                
                console.log('Generated', numberOfLines, 'optimized pattern lines');
            }
            
            // Generate pattern lines on load
            generatePatternLines();
            
            // Regenerate lines on resize
            window.addEventListener('resize', generatePatternLines);
            
            // Ensure minimum display time of 2 seconds, regardless of page load speed
            const minDisplayTime = 2000; // 2 seconds minimum
            const startTime = Date.now();
            
            // Start enlarging animation 800ms before fade-out begins
            function startEnlarging() {
                const loadingLogo = loadingScreen.querySelector('.loading-logo');
                if (loadingLogo) {
                    // Trigger the enlarging animation by adding fade-out class to screen
                    loadingScreen.classList.add('fade-out');
                    // But remove the opacity transition temporarily to only get the animation
                    loadingScreen.style.transition = 'none';
                    loadingScreen.style.opacity = '1';
                }
            }
            
            function startFadeOut() {
                const elapsedTime = Date.now() - startTime;
                const remainingTime = Math.max(0, minDisplayTime - elapsedTime);
                
                // Start enlarging animation 800ms before fade-out
                const enlargingTime = Math.max(0, remainingTime - 200);
                
                setTimeout(function() {
                    startEnlarging();
                }, enlargingTime);
                
                setTimeout(function() {
                    // Restore the transition and start actual fade-out
                    loadingScreen.style.transition = 'opacity 0.6s ease-out';
                    
                    // First fade out the logo
                    const loadingLogo = loadingScreen.querySelector('.loading-logo');
                    if (loadingLogo) {
                        loadingLogo.classList.add('fade-out');
                    }
                    
                    // Fade out the pattern container along with the logo
                    if (patternContainer) {
                        patternContainer.classList.add('fade-out');
                    }
                    
                    // Then fade out the background 200ms later
                    setTimeout(function() {
                        loadingScreen.style.opacity = '0';
                    }, 200);
                    
                    // Remove loading screen from DOM after fade out completes
                    // Give extra time for the scaling animation to be visible
                    setTimeout(function() {
                        loadingScreen.remove();
                    }, 1000); // Increased to 1 second to see the scaling effect
                }, remainingTime);
            }
            
            // Check if page is ready, but enforce minimum display time
            setTimeout(function() {
                if (document.readyState === 'complete') {
                    startFadeOut();
                } else {
                    // If not fully loaded, wait a bit more but still respect minimum time
                    setTimeout(function() {
                        startFadeOut();
                    }, 500);
                }
            }, 100); // Small initial delay to let everything settle
        });
    </script>
</body>
</html>
