<!DOCTYPE html>
<html lang="dv">
<head>
  <meta charset="UTF-8">
  <title>Rhythm Lyrics - CSV</title>
  <!-- Disable browser zooming completely -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <link rel="icon" type="image/png" sizes="192x192" href="favicons/icons-192.png">
<link rel="icon" type="image/png" sizes="512x512" href="favicons/icons-512.png">
<link rel="manifest" href="favicons/manifest.webmanifest">
  <style>
    /* Load local fonts from Fonts folder */
    @font-face {
      font-family: 'Faruma';
      src: url('Fonts/Faruma.ttf') format('truetype');
      font-display: swap;
      font-weight: normal;
      font-style: normal;
    }
    
    @font-face {
      font-family: 'Montserrat';
      src: url('Fonts/Montserrat-VariableFont_wght.ttf') format('truetype');
      font-display: swap;
      font-weight: normal;
      font-style: normal;
    }
    
    html, body {
      /* Allow scrolling, but prevent zoom gestures */
      touch-action: pan-x pan-y;
      overscroll-behavior: none;
    }
    input, textarea, select, button {
      touch-action: manipulation;
    }
    :root {
      --primary-color: #f5d000;
      --hover-color: #fced98;
      --active-color: #E6B800;
      --text-color: #2b2b2b;
      --bg-opacity: rgba(31, 31, 31, 0.0);
      --hover-color2: #3a3a3a;
      --active-color2: #111111
    }
    @keyframes fadeIn {
      0% { opacity: 0; }
      100% { opacity: 1; }
    }
    @keyframes slideIn {
      0% { transform: translateY(10px); opacity: 0; }
      100% { transform: translateY(0); opacity: 1; }
    }
    body {
      /* Use Montserrat for English text */
      font-family: 'Montserrat', 'SF-Pro', Arial, sans-serif;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      background-color: #1f1f1f;
      background-size: cover;
      color: var(--primary-color);
      animation: fadeIn 0.5s ease-in-out;
    }
    .container {
      text-align: center;
      position: relative;
      max-width: 600px;
      width: 100%; 
      padding: 20px;
      background: var(--bg-opacity);
      border-radius: 10px;
      transition: all 0.2s ease;
      animation: slideIn 0.3s ease-in-out;
      margin-top: 40px;
      margin-bottom: 40px;
      opacity: 0;
      visibility: hidden;
      transform: translateY(10px);
    }
    
    .container.ready {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }
    
    .offline-indicator {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: #ff6b6b;
      color: white;
      text-align: center;
      padding: 5px;
      font-size: 0.9em;
      z-index: 200;
      display: none;
      font-family: 'Montserrat', 'SF-Pro', Arial, sans-serif;
    }
    
    .offline-indicator.show {
      display: block;
    }
    .back-button {
      background-color: var(--primary-color);
      color: var(--text-color);
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      font-size: 18px;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 0;
      z-index: 10;
    }
    .controls-row {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 15px;
      gap: 20px;
    }
    .back-button:hover {
      background-color: var(--hover-color);
      transform: scale(1.1);
    }
    .back-button:active {
      background-color: var(--active-color);
      transform: scale(0.95);
    }
    button {
      background-color: var(--primary-color);
      color: var(--text-color);
      border: none;
      border-radius: 5px;
      padding: 10px 18px;
      font-size: 1em;
      cursor: pointer;
      margin-bottom: 20px;
      transition: background-color 0.3s, transform 0.2s;
      font-family: 'Montserrat', 'SF-Pro', Arial, sans-serif;
    }
    button:hover {
      background-color: var(--hover-color);
      font-weight: bold;
    }
    button:active {
      background-color: var(--active-color);
      transform: scale(0.97);
    }
    .language-toggle {
      display: flex;
      justify-content: center;
      margin-bottom: 0;
      margin-top: 0;
    }
    .toggle-switch {
      position: relative;
      width: 200px;
      height: 50px;
      background-color: #555;
      border-radius: 25px;
      border: 2px solid #666;
      cursor: pointer;
      transition: all 0.3s ease;
      overflow: hidden;
    }
    .toggle-switch.disabled {
      cursor: not-allowed;
      opacity: 0.6;
      background-color: #333;
      border-color: #444;
    }
    .toggle-switch.disabled .toggle-label.english {
      text-decoration: line-through;
    }
    .toggle-switch.generating {
      cursor: wait;
      opacity: 0.8;
      background-color: #444;
      border-color: #555;
    }
    .toggle-switch.generating .toggle-label.english::after {
      content: " (generating...)";
      font-size: 0.7em;
      color: #888;
    }
    .toggle-switch.ready {
      cursor: pointer;
      opacity: 1;
      background-color: #555;
      border-color: #666;
      transition: all 0.3s ease;
    }
    .toggle-switch.ready:hover {
      border-color: var(--primary-color);
      background-color: #666;
      transform: scale(1.02);
    }
    .toggle-switch.ready:active {
      transform: scale(0.98);
    }
    .toggle-slider {
      position: absolute;
      top: 2px;
      left: 2px;
      width: 96px;
      height: 42px;
      background-color: var(--primary-color);
      border-radius: 21px;
      transition: transform 0.3s ease, font-family 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: var(--text-color);
      font-size: 0.9em;
      z-index: 2;
      font-family: 'Faruma', 'MV Elaaf Normal', 'Faruma Regular', 'Faruma Medium', 'Noto Sans Thaana', 'Thaana Unicode', Arial, sans-serif;
    }
    .toggle-slider.english {
      transform: translateX(96px);
      font-family: 'Montserrat', 'SF-Pro', Arial, sans-serif;
    }
    .toggle-labels {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      z-index: 1;
    }
    .toggle-label {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.9em;
      font-family: 'Montserrat', 'SF-Pro', Arial, sans-serif;
      transition: color 0.3s ease;
      pointer-events: none;
    }
    .toggle-label.dhivehi {
      color: var(--text-color);
      font-family: 'Faruma', 'MV Elaaf Normal', 'Faruma Regular', 'Faruma Medium', 'Noto Sans Thaana', 'Thaana Unicode', Arial, sans-serif;
    }
    .toggle-label.english {
      color: #ccc;
    }
    .toggle-switch:not(.disabled):hover {
      border-color: var(--primary-color);
    }
    .language-btn {
      display: none; /* Hide the old buttons */
    }
    .lyrics-template {
      margin-top: 0;
      display: none;
      direction: rtl;
      font-size: 1.6em; /* Dhivehi font size */
      white-space: pre-line;
      color: #FFFFFF;
      background: rgba(43,43,43,0.7);
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.07);
      text-align: right;
      line-height: 2em;
      font-family: 'Faruma', 'MV Elaaf Normal', 'Faruma Regular', 'Faruma Medium', 'Noto Sans Thaana', 'Thaana Unicode', Arial, sans-serif;
      user-select: none;
      -webkit-user-select: none;
      -ms-user-select: none;
      -moz-user-select: none;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .lyrics-template.english {
      font-size: 1.4em; /* English font size */
      font-family: 'Montserrat', 'SF-Pro', Arial, sans-serif;
      direction: ltr;
      text-align: left;
    }
    
    .lyrics-template.ready {
      opacity: 1;
    }
    .lyrics-template * {
      user-select: none;
      -webkit-user-select: none;
      -ms-user-select: none;
      -moz-user-select: none;
    }
    h2#song-title {
      color: var(--primary-color);
      text-align: center;
      font-family: 'Montserrat', 'SF-Pro', Arial, sans-serif;
      margin: 0 0 20px 0;
      padding: 0;
    }
    .highlight-line {
      color: #f5d000;
    }
    .section-nav-bar {
      position: fixed;
      left: 0;
      bottom: 20px;
      display: flex;
      flex-direction: column;
      gap: 0;
      z-index: 1000;
      background: rgba(31,31,31,0.85);
      box-shadow: 2px 0 8px rgba(0,0,0,0.08);
      border-radius: 0 8px 8px 0;
      padding: 12px 0 12px 0;
      /* Prevent scaling and panning */
      touch-action: none;
      pointer-events: auto;
      will-change: transform;
      transition: left 0.3s ease, right 0.3s ease, border-radius 0.3s ease, box-shadow 0.3s ease, opacity 0.3s ease;
      opacity: 0;
    }
    
    .section-nav-bar.ready {
      opacity: 1;
    }
    .section-nav-bar.english {
      left: auto;
      right: 0;
      border-radius: 8px 0 0 8px;
      box-shadow: -2px 0 8px rgba(0,0,0,0.08);
    }
    .section-nav-bar,
    .section-nav-bar * {
      /* Prevent zoom and scale on nav bar, but allow scrolling elsewhere */
      touch-action: none !important;
      user-select: none !important;
      -webkit-user-drag: none !important;
      -webkit-touch-callout: none !important;
    }
    .section-nav-bar button {
      border: none;
      border-radius: 0;
      padding: 8px 14px;
      margin: 0;
      font-size: 1.1em;
      cursor: pointer;
      font-family: 'Montserrat', 'SF-Pro', Arial, sans-serif;
      text-align: left;
      transition: background 0.2s;
      white-space: nowrap;
      outline: none;
    }
    .section-nav-bar .yellow-btn {
      background: var(--primary-color);
      color: var(--text-color);
      border-radius: 0 5px 5px 0;
      margin-bottom: 5px;
    }
    .section-nav-bar.english .yellow-btn {
      border-radius: 5px 0 0 5px;
    }
    .section-nav-bar .yellow-btn:hover {
      background: var(--hover-color);
      font-weight: bold;
    }
    .section-nav-bar .white-btn {
      background: #cccccc;
      color: #222;
      border-radius: 0 5px 5px 0;
      margin-bottom: 5px;
      margin-left: 0;
    }
    .section-nav-bar.english .white-btn {
      border-radius: 5px 0 0 5px;
    }
    .section-nav-bar .white-btn:hover {
      background: #f5f5f5;
      font-weight: bold;

    }
    .section-block {
      background: rgba(43,43,43,0.85);
      border-radius: 8px;
      margin-bottom: 24px;
      padding: 18px 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.07);
      transition: background 0.3s;
      position: relative;
    }
    .section-block.flash {
      background: #464646 !important;
      transition: background 0.5s;
    }
    .section-name-overlay {
      position: absolute;
      top: 0;
      left: 0;
      font-size: 3em;
      font-weight: bold;
      opacity: 0.08;
      color: #ffffff;
      pointer-events: none;
      user-select: none;
      -webkit-user-select: none;
      -ms-user-select: none;
      -moz-user-select: none;
      z-index: 10;
      line-height: 1;
      font-family: 'Montserrat', 'SF-Pro', Arial, sans-serif;
      transition: left 0.3s ease, right 0.3s ease;
    }
    .section-name-overlay.english {
      left: auto;
      right: 0;
      font-family: 'Montserrat', 'SF-Pro', Arial, sans-serif;
    }
    .break-line {
      width: 100%;
      height: 6px;
      background: var(--primary-color);
      border-radius: 8px;
      margin: 24px 0 24px 0;
      display: flex;
      align-items: center;
      position: relative;
      opacity: 0.85;
    }
    .loading-indicator {
      display: none;
      color: #f5d000;
      font-size: 0.9em;
      margin-top: 10px;
      font-family: 'Montserrat', 'SF-Pro', Arial, sans-serif;
    }
    .loading-indicator.show {
      display: block;
    }
    @media (max-width: 700px) {
      .container {
        max-width: 95vw;
        padding: 10px;
        margin-top: 20px;
      }
      .back-button {
        width: 35px;
        height: 35px;
        font-size: 16px;
      }
      .controls-row {
        margin-bottom: 10px;
        gap: 15px;
      }
      .toggle-switch {
        width: 180px;
        height: 45px;
      }
      .toggle-slider {
        width: 86px;
        height: 37px;
      }
      .toggle-slider.english {
        transform: translateX(86px);
      }
      .toggle-label {
        font-size: 0.8em;
      }
      .lyrics-template {
        font-size: 1.4em; /* Dhivehi mobile font size */
        padding: 15px;
        line-height: 1.8em;
      }
      
      .lyrics-template.english {
        font-size: 1.2em; /* English mobile font size */
      }
      .section-nav-bar {
        bottom: 15px;
        padding: 10px 0;
      }
      .section-nav-bar.english {
        right: 0;
      }
      .section-nav-bar button {
        padding: 6px 10px;
        font-size: 1.2em;
      }
      .section-nav-bar .yellow-btn,
      .section-nav-bar .white-btn {
        margin-bottom: 3px;
      }
      .section-nav-bar.english .yellow-btn,
      .section-nav-bar.english .white-btn {
        margin-bottom: 3px;
      }
    }
    
    /* PIN Entry Styles */
    .pin-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #1f1f1f;
      z-index: 15000;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
    }
    
    .pin-container {
      background: rgba(43,43,43,0.9);
      padding: 30px;
      border-radius: 15px;
      text-align: center;
      border: 2px solid #444;
      max-width: 300px;
      width: 85%;
    }
    
    .pin-title {
      color: var(--primary-color);
      font-size: 1.3em;
      margin-bottom: 25px;
      font-family: 'Montserrat', 'SF-Pro', Arial, sans-serif;
      font-weight: 600;
    }
    
    .pin-inputs {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-bottom: 20px;
    }
    
    .pin-digit {
      width: 50px;
      height: 50px;
      padding: 0;
      font-size: 1.5em;
      text-align: center;
      border: 2px solid #444;
      border-radius: 8px;
      background: #222;
      color: var(--primary-color);
      outline: none;
      font-family: 'Montserrat', 'SF-Pro', Arial, sans-serif;
      transition: all 0.3s ease;
      caret-color: transparent;
      /* Force numerical keyboard on mobile */
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: textfield;
    }
    
    .pin-digit:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(245, 208, 0, 0.2);
      transform: scale(1.05);
    }
    
    .pin-digit.filled {
      background: rgba(245, 208, 0, 0.1);
      border-color: var(--primary-color);
    }
    
    .pin-digit.error {
      border-color: #ff6b6b;
      animation: shake 0.5s;
    }
    
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-3px); }
      75% { transform: translateX(3px); }
    }
    
    .pin-error {
      color: #ff6b6b;
      font-size: 0.85em;
      margin-top: 5px;
      min-height: 18px;
      font-family: 'Montserrat', 'SF-Pro', Arial, sans-serif;
    }
    
    .pin-overlay.hidden {
      display: none;
    }
    
    /* Mobile responsive adjustments */
    @media (max-width: 400px) {
      .pin-container {
        padding: 20px;
        max-width: 90%;
      }
      
      .pin-digit {
        width: 45px;
        height: 45px;
        font-size: 1.3em;
      }
      
      .pin-inputs {
        gap: 8px;
      }
    }
    
    /* Loading Screen Styles */
    @keyframes spin-and-scale {
      from { transform: rotate(0deg) scale(1); }
      to { transform: rotate(360deg) scale(1); }
    }

    @keyframes spin-and-scale-smooth {
      0% { transform: rotate(0deg); width: 80px; height: 80px; }
      25% { transform: rotate(90deg); width: 200px; height: 200px; }
      50% { transform: rotate(180deg); width: 800px; height: 800px; }
      75% { transform: rotate(270deg); width: 2400px; height: 2400px; }
      100% { transform: rotate(360deg); width: 4000px; height: 4000px; }
    }

    @keyframes slideLeft {
      0% { transform: translateX(0) translateZ(0); }
      100% { transform: translateX(-100vw) translateZ(0); }
    }

    @keyframes slideRight {
      0% { transform: translateX(-100vw) translateZ(0); }
      100% { transform: translateX(0) translateZ(0); }
    }

    .loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: #2b2b2b;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10000;
      transition: opacity 0.2s ease-out;
    }

    .loading-screen.fade-out {
      opacity: 0;
      pointer-events: none;
    }

    .loading-logo {
      width: 80px;
      height: 80px;
      animation: spin-and-scale 3s linear infinite;
      transition: none;
      position: relative;
      z-index: 2;
    }

    .loading-logo.fade-out {
      opacity: 0;
      transition: opacity 0.4s ease-out;
    }

    .loading-screen.fade-out .loading-logo {
      animation: spin-and-scale-smooth 1.5s ease-out infinite;
    }

    .loading-progress {
      position: absolute;
      bottom: 20%;
      left: 50%;
      transform: translateX(-50%);
      color: var(--primary-color);
      font-family: 'Montserrat', 'SF-Pro', Arial, sans-serif;
      font-size: 1em;
      font-weight: 500;
      text-align: center;
      z-index: 3;
      opacity: 0.8;
      transition: opacity 0.3s ease;
    }

    .loading-progress.fade-out {
      opacity: 0;
    }

    .pattern-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      z-index: 1;
      opacity: 0.25;
      transition: opacity 0.6s ease-out;
      will-change: opacity;
      transform: translateZ(0);
    }

    .pattern-container.fade-out {
      opacity: 0;
    }

    .pattern-line {
      position: absolute;
      height: 40px;
      width: 300vw;
      background-image: url('src/repeatp.svg');
      background-repeat: repeat-x;
      background-size: auto 40px;
      left: -100vw;
      will-change: transform;
      transform: translateZ(0);
    }

    .pattern-line:nth-child(odd) {
      animation: slideLeft 10s linear infinite;
    }

    .pattern-line:nth-child(even) {
      animation: slideRight 10s linear infinite;
    }
  </style>
  <script>
    // Prevent zoom with keyboard (Ctrl/Cmd + +/-/0) and mouse wheel
    document.addEventListener('keydown', function(e) {
      if ((e.ctrlKey || e.metaKey) && (
        e.key === '+' || e.key === '-' || e.key === '=' || e.key === '0'
      )) {
        e.preventDefault();
      }
    });
    document.addEventListener('wheel', function(e) {
      if (e.ctrlKey) e.preventDefault();
    }, { passive: false });
    // Prevent double-tap zoom on mobile
    let lastTouchEnd = 0;
    document.addEventListener('touchend', function(e) {
      const now = (new Date()).getTime();
      if (now - lastTouchEnd <= 350) {
        e.preventDefault();
      }
      lastTouchEnd = now;
    }, false);
    // Prevent pinch-zoom and gesture events on iOS/Safari
    document.addEventListener('gesturestart', function(e) {
      e.preventDefault();
    });
    document.addEventListener('gesturechange', function(e) {
      e.preventDefault();
    });
    document.addEventListener('gestureend', function(e) {
      e.preventDefault();
    });

    // Register service worker for offline functionality
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        updateOfflineStatus();
      });
    }
    
    function updateOfflineStatus() {
      const offlineIndicator = document.getElementById('offline-indicator');
      if (!navigator.onLine) {
        offlineIndicator.classList.add('show');
      } else {
        offlineIndicator.classList.remove('show');
      }
    }
  </script>
</head>
<body>
  <!-- Loading Screen -->
  <div class="loading-screen" id="loading-screen">
    <!-- Animated Pattern Background -->
    <div class="pattern-container" id="pattern-container">
      <!-- Pattern lines will be generated by JavaScript -->
    </div>
    <img src="src/Logo_1.svg" alt="Rhythm Boduberu Loading" class="loading-logo">
    <div class="loading-progress" id="loading-progress">Loading...</div>
  </div>

  <div class="pin-overlay" id="pin-overlay">
    <div class="pin-container">
      <h2 class="pin-title">Enter PIN</h2>
      <div class="pin-inputs">
        <input type="tel" class="pin-digit" maxlength="1" pattern="[0-9]" inputmode="numeric">
        <input type="tel" class="pin-digit" maxlength="1" pattern="[0-9]" inputmode="numeric">
        <input type="tel" class="pin-digit" maxlength="1" pattern="[0-9]" inputmode="numeric">
        <input type="tel" class="pin-digit" maxlength="1" pattern="[0-9]" inputmode="numeric">
      </div>
      <div class="pin-error" id="pin-error"></div>
    </div>
  </div>
  
  <div class="offline-indicator" id="offline-indicator">
    You're offline - Using cached content
  </div>
  <div class="section-nav-bar" id="section-nav-bar"></div>
  <div class="container">
    <h2 id="song-title"></h2>
    <div class="controls-row">
      <button class="back-button" onclick="
        window.location.href='songlist'
      ">←</button>
      <div class="language-toggle">
        <div class="toggle-switch" id="toggle-switch">
          <div class="toggle-slider" id="toggle-slider">ދިވެހި</div>
          <div class="toggle-labels">
            <div class="toggle-label dhivehi">ދިވެހި</div>
            <div class="toggle-label english">English</div>
          </div>
        </div>
      </div>
    </div>
    <div class="loading-indicator" id="loading-indicator">
      Generating English lyrics...
    </div>
    <div id="lyrics-template" class="lyrics-template" dir="rtl">
      <div id="song-lyrics"></div>
    </div>
  </div>
  <script src="lyrics-showlist-config.js"></script>
  <script src="rhythm-session-manager.js"></script>
  <script src="rhythm-data-service.js"></script>
  <script src="rhythm-page-transition.js"></script>
  <script src="reverse-transliteration.js"></script>
  <script>
    // Rhythm Lyrics Application using Shared Services
    const RhythmLyrics = (function() {
      'use strict';
      
      // Application state
      const STATE = {
        currentSong: null,
        currentLanguage: 'dhivehi',
        englishAvailable: false,
        generatedEnglishLyrics: null,
        isInitialized: false
      };
      
      // DOM Elements
      const ELEMENTS = {};
      
      // PIN Management using shared session manager
      const PinManager = {
        init() {
          this.setupElements();
          this.setupEventListeners();
          this.checkAuthStatus();
        },

        setupElements() {
          ELEMENTS.pinOverlay = document.getElementById('pin-overlay');
          ELEMENTS.pinDigits = [...document.querySelectorAll('.pin-digit')];
          ELEMENTS.pinError = document.getElementById('pin-error');
        },

        setupEventListeners() {
          // Setup PIN input handlers
          ELEMENTS.pinDigits.forEach((digit, index) => {
            digit.addEventListener('input', (e) => this.handleDigitInput(e, index));
            digit.addEventListener('keydown', (e) => this.handleDigitKeydown(e, index));
            digit.addEventListener('paste', this.handlePaste.bind(this));
          });

          // Listen to session manager events
          window.RhythmSession.on('authenticationSuccess', () => {
            this.hidePinOverlay();
            App.loadSongData();
          });

          window.RhythmSession.on('sessionExpired', () => {
            this.showPinOverlay();
          });

          window.RhythmSession.on('sessionRestored', () => {
            this.hidePinOverlay();
            App.loadSongData();
          });

          window.RhythmSession.on('lockoutStarted', () => {
            this.disablePinInputs();
          });

          window.RhythmSession.on('lockoutUpdate', (data) => {
            const { minutes, seconds } = data;
            this.showPinError(`Too many attempts. Try again in ${minutes}:${seconds.toString().padStart(2, '0')}`);
          });

          window.RhythmSession.on('lockoutCleared', () => {
            this.enablePinInputs();
            this.showPinError('Lockout expired. You may try again.');
            setTimeout(() => {
              this.clearPinError();
              ELEMENTS.pinDigits[0].focus();
            }, 2000);
          });
        },

        checkAuthStatus() {
          if (window.RhythmSession && window.RhythmSession.isAuthenticated()) {
            // Don't hide loading screen here - let it continue until all content is loaded
            this.hidePinOverlay();
            App.loadSongData();
          } else if (window.RhythmSession && window.RhythmSession.isLockedOut()) {
            LoadingScreen.hide();
            this.showPinOverlay();
            this.disablePinInputs();
          } else {
            // Check for basic session in sessionStorage as fallback
            const sessionData = sessionStorage.getItem('pinSession');
            if (sessionData) {
              try {
                const session = JSON.parse(sessionData);
                const sessionAge = Date.now() - session.timestamp;
                if (session.authenticated && sessionAge < (15 * 60 * 1000 * 2)) { // 30 min fallback
                  // Don't hide loading screen here - let it continue until all content is loaded
                  this.hidePinOverlay();
                  App.loadSongData();
                  return;
                }
              } catch (e) {
                // Invalid session data
              }
            }
            
            LoadingScreen.hide();
            this.showPinOverlay();
            setTimeout(() => ELEMENTS.pinDigits[0].focus(), 300);
          }
        },

        async handleDigitInput(e, index) {
          if (e.target.disabled) return;
          
          const value = e.target.value;
          
          if (!/^\d$/.test(value)) {
            e.target.value = '';
            return;
          }

          this.clearPinError();
          e.target.classList.add('filled');
          
          if (index < 3) {
            ELEMENTS.pinDigits[index + 1].focus();
          } else {
            await this.verifyPin();
          }
        },

        handleDigitKeydown(e, index) {
          if (e.target.disabled) return;
          
          if (e.key === 'Backspace') {
            e.target.value = '';
            e.target.classList.remove('filled');
            if (index > 0) {
              ELEMENTS.pinDigits[index - 1].focus();
            }
          }
          
          if (e.key === 'Enter') {
            this.verifyPin();
          }
          
          if (e.key === 'ArrowLeft' && index > 0) {
            ELEMENTS.pinDigits[index - 1].focus();
          }
          if (e.key === 'ArrowRight' && index < 3) {
            ELEMENTS.pinDigits[index + 1].focus();
          }
        },

        handlePaste(e) {
          e.preventDefault();
          const pasteData = e.clipboardData.getData('text');
          
          if (/^\d{4}$/.test(pasteData)) {
            ELEMENTS.pinDigits.forEach((digit, index) => {
              digit.value = pasteData[index];
              digit.classList.add('filled');
            });
            this.verifyPin();
          }
        },

        async verifyPin() {
          const enteredPin = ELEMENTS.pinDigits.map(digit => digit.value).join('');
          
          if (enteredPin.length !== 4) {
            this.showPinError('Please enter all 4 digits');
            return;
          }

          try {
            await window.RhythmSession.authenticateWithPin(enteredPin);
          } catch (error) {
            this.showPinError(error.message);
            this.clearPinInputs();
            setTimeout(() => {
              ELEMENTS.pinDigits[0].focus();
            }, 1000);
          }
        },

        showPinError(message) {
          ELEMENTS.pinError.textContent = message;
          ELEMENTS.pinDigits.forEach(digit => {
            digit.classList.add('error');
          });
          setTimeout(() => {
            ELEMENTS.pinDigits.forEach(digit => {
              digit.classList.remove('error');
            });
          }, 500);
        },

        clearPinError() {
          ELEMENTS.pinError.textContent = '';
          ELEMENTS.pinDigits.forEach(digit => {
            digit.classList.remove('error');
          });
        },

        clearPinInputs() {
          ELEMENTS.pinDigits.forEach(digit => {
            digit.value = '';
            digit.classList.remove('filled');
          });
        },

        disablePinInputs() {
          ELEMENTS.pinDigits.forEach(digit => digit.disabled = true);
        },

        enablePinInputs() {
          ELEMENTS.pinDigits.forEach(digit => {
            digit.disabled = false;
            digit.value = '';
            digit.classList.remove('filled');
          });
        },

        showPinOverlay() {
          ELEMENTS.pinOverlay.classList.remove('hidden');
        },

        hidePinOverlay() {
          ELEMENTS.pinOverlay.classList.add('hidden');
        }
      };

      // Loading Screen Management
      const LoadingScreen = {
        init() {
          this.setupElements();
          this.generatePatternLines();
        },

        setupElements() {
          ELEMENTS.loadingScreen = document.getElementById('loading-screen');
          ELEMENTS.loadingProgress = document.getElementById('loading-progress');
          ELEMENTS.patternContainer = document.getElementById('pattern-container');
        },

        generatePatternLines() {
          if (!ELEMENTS.patternContainer) return;
          
          const viewportHeight = window.innerHeight;
          const lineHeight = 40;
          const numberOfLines = Math.ceil(viewportHeight / lineHeight) + 1;
          
          ELEMENTS.patternContainer.innerHTML = '';
          
          for (let i = 0; i < numberOfLines; i++) {
            const line = document.createElement('div');
            line.className = 'pattern-line';
            line.style.top = (i * lineHeight) + 'px';
            line.style.willChange = 'transform';
            line.style.transform = 'translateZ(0)';
            ELEMENTS.patternContainer.appendChild(line);
          }
        },

        show(text = 'Loading...') {
          if (ELEMENTS.loadingScreen) {
            ELEMENTS.loadingScreen.style.display = 'flex';
            ELEMENTS.loadingScreen.classList.remove('fade-out');
          }
          this.updateProgress(text);
        },

        hide() {
          if (ELEMENTS.loadingScreen) {
            ELEMENTS.loadingScreen.classList.add('fade-out');
            setTimeout(() => {
              ELEMENTS.loadingScreen.style.display = 'none';
            }, 600);
          }
        },

        updateProgress(text) {
          if (ELEMENTS.loadingProgress) {
            ELEMENTS.loadingProgress.textContent = text;
          }
        }
      };

      // Lyrics Management
      const LyricsManager = {
        init() {
          this.setupElements();
          this.setupEventListeners();
        },

        setupElements() {
          ELEMENTS.songTitle = document.getElementById('song-title');
          ELEMENTS.songLyrics = document.getElementById('song-lyrics');
          ELEMENTS.lyricsTemplate = document.getElementById('lyrics-template');
          ELEMENTS.sectionNavBar = document.getElementById('section-nav-bar');
          ELEMENTS.toggleSlider = document.getElementById('toggle-slider');
          ELEMENTS.toggleSwitch = document.getElementById('toggle-switch');
          ELEMENTS.loadingIndicator = document.getElementById('loading-indicator');
          
          // Log the elements to help debug
          console.log('🔍 Setup elements:', {
            toggleSwitch: !!ELEMENTS.toggleSwitch,
            toggleSlider: !!ELEMENTS.toggleSlider,
            songTitle: !!ELEMENTS.songTitle
          });
        },

        setupEventListeners() {
          // Language toggle - initially disable until English lyrics are ready
          if (ELEMENTS.toggleSwitch) {
            // Remove any existing onclick attributes
            ELEMENTS.toggleSwitch.removeAttribute('onclick');
            
            // Set initial disabled state
            ELEMENTS.toggleSwitch.classList.add('disabled');
            ELEMENTS.toggleSwitch.style.cursor = 'not-allowed';
            ELEMENTS.toggleSwitch.style.opacity = '0.6';
            
            // Add a temporary click handler that shows a message
            ELEMENTS.toggleSwitch.addEventListener('click', (e) => {
              e.preventDefault();
              e.stopPropagation();
              console.log('⚠️ Toggle clicked but English lyrics not ready yet');
            });
          }

          // Back button using page transition manager
          const backButton = document.querySelector('.back-button');
          if (backButton) {
            backButton.addEventListener('click', (e) => {
              e.preventDefault();
              if (window.RhythmPageTransition) {
                window.RhythmPageTransition.navigateToSonglist();
              } else {
                window.location.href = 'songlist.html';
              }
            });
          }
        },

        async loadSong() {
          const selectedId = localStorage.getItem('selectedSongId');
          if (!selectedId) {
            this.showError('No song selected');
            return;
          }

          try {
            let song = null;
            let usedPreloadedData = false;
            
            // First, check for preloaded song data from navigation
            const preloadedSongData = sessionStorage.getItem('preloadedSong');
            const preloadedTimestamp = sessionStorage.getItem('preloadedSongTimestamp');
            
            if (preloadedSongData && preloadedTimestamp) {
              try {
                const preloadedSong = JSON.parse(preloadedSongData);
                const dataAge = Date.now() - parseInt(preloadedTimestamp);
                
                // Use preloaded data if it's recent (within 5 minutes) and matches
                if (dataAge < 5 * 60 * 1000 && String(preloadedSong.id) === String(selectedId)) {
                  song = preloadedSong;
                  usedPreloadedData = true;
                  console.log('Using preloaded song data for instant display');
                }
                
                // Clear the preloaded data
                sessionStorage.removeItem('preloadedSong');
                sessionStorage.removeItem('preloadedSongTimestamp');
              } catch (e) {
                console.warn('Invalid preloaded song data:', e);
                sessionStorage.removeItem('preloadedSong');
                sessionStorage.removeItem('preloadedSongTimestamp');
              }
            }
            
            // If no preloaded data, get from shared data service
            if (!song && window.RhythmData) {
              song = await window.RhythmData.getSongById(selectedId);
            }

            if (song) {
              STATE.currentSong = song;
              this.displaySong(song);
              
              // Start lazy refresh timer for background data updates (only if we used preloaded data)
              if (usedPreloadedData && window.RhythmData && typeof window.RhythmData.startLyricsPageTimer === 'function') {
                window.RhythmData.startLyricsPageTimer();
              }
            } else {
              this.showError('Song not found');
            }
          } catch (error) {
            console.error('Failed to load song:', error);
            this.showError('Failed to load song');
          }
        },

        displaySong(song) {
          if (ELEMENTS.songTitle) {
            ELEMENTS.songTitle.textContent = song.name;
          }

          // Display Dhivehi lyrics first to ensure content is rendered
          this.renderLyrics(song.lyrics, 'dhivehi');
          
          // Generate English lyrics immediately in background
          this.generateEnglishLyrics(song.lyrics);
          
          // Show UI elements after lyrics are rendered
          this.showUI();
        },

        async generateEnglishLyrics(dhivehiLyrics) {
          console.log('🔄 Starting English lyrics generation...');
          
          // Check if we have cached English lyrics for this song
          const cacheKey = `englishLyrics_${STATE.currentSong.id}`;
          const cachedLyrics = localStorage.getItem(cacheKey);
          
          if (cachedLyrics) {
            console.log('✅ Using cached English lyrics');
            STATE.generatedEnglishLyrics = cachedLyrics;
            STATE.englishAvailable = true;
            this.enableLanguageToggle();
            return;
          }
          
          // Show generating state
          if (ELEMENTS.toggleSwitch) {
            ELEMENTS.toggleSwitch.classList.remove('disabled');
            ELEMENTS.toggleSwitch.classList.add('generating');
          }
          
          if (ELEMENTS.loadingIndicator) {
            ELEMENTS.loadingIndicator.classList.add('show');
          }

          try {
            // Small delay to allow UI to render first
            await new Promise(resolve => setTimeout(resolve, 50));

            if (window.reverseTransliterate) {
              console.log('✅ Transliteration function available');
              const lines = dhivehiLyrics.split('\n');
              const transliteratedLines = lines.map(line => {
                const trimmedLine = line.trim();
                
                // Keep section headers and separators as-is
                if (/^[#$][A-Za-z0-9]+/.test(trimmedLine) || /^-+$/.test(trimmedLine)) {
                  return line;
                }
                
                // Handle highlighted lines (starting with *)
                if (trimmedLine.startsWith('*')) {
                  const content = trimmedLine.substring(1).trim();
                  return '*' + window.reverseTransliterate(content);
                }
                
                // Keep empty lines
                if (!trimmedLine) {
                  return line;
                }
                
                // Transliterate regular content lines
                return window.reverseTransliterate(trimmedLine);
              });
              
              STATE.generatedEnglishLyrics = transliteratedLines.join('\n');
              STATE.englishAvailable = true;
              
              // Cache the generated English lyrics
              try {
                localStorage.setItem(cacheKey, STATE.generatedEnglishLyrics);
                console.log('✅ English lyrics cached for future use');
              } catch (e) {
                console.warn('⚠️ Could not cache English lyrics:', e);
              }
              
              console.log('✅ English lyrics generated successfully');
              
              // Enable toggle switch and update UI
              this.enableLanguageToggle();
              
            } else {
              console.warn('⚠️ Transliteration function not available');
              // Fallback: use original lyrics as placeholder
              STATE.generatedEnglishLyrics = dhivehiLyrics;
              STATE.englishAvailable = false;
              
              // Keep disabled state
              if (ELEMENTS.toggleSwitch) {
                ELEMENTS.toggleSwitch.classList.remove('generating');
                ELEMENTS.toggleSwitch.classList.add('disabled');
              }
            }
          } catch (error) {
            console.error('❌ Error generating English lyrics:', error);
            STATE.generatedEnglishLyrics = dhivehiLyrics;
            STATE.englishAvailable = false;
            
            // Show error state
            if (ELEMENTS.toggleSwitch) {
              ELEMENTS.toggleSwitch.classList.remove('generating');
              ELEMENTS.toggleSwitch.classList.add('disabled');
            }
          } finally {
            if (ELEMENTS.loadingIndicator) {
              ELEMENTS.loadingIndicator.classList.remove('show');
            }
          }
        },

        enableLanguageToggle() {
          console.log('🔄 Enabling language toggle...');
          
          // Enable toggle switch with ready state
          if (ELEMENTS.toggleSwitch) {
            ELEMENTS.toggleSwitch.classList.remove('disabled', 'generating');
            ELEMENTS.toggleSwitch.classList.add('ready');
            ELEMENTS.toggleSwitch.style.cursor = 'pointer';
            ELEMENTS.toggleSwitch.style.opacity = '1';
            
            // Remove any existing event listeners to prevent duplicates
            const newToggle = ELEMENTS.toggleSwitch.cloneNode(true);
            ELEMENTS.toggleSwitch.parentNode.replaceChild(newToggle, ELEMENTS.toggleSwitch);
            
            // Update the references to the new elements
            ELEMENTS.toggleSwitch = newToggle;
            ELEMENTS.toggleSlider = newToggle.querySelector('#toggle-slider');
            
            // Add fresh click handler
            ELEMENTS.toggleSwitch.addEventListener('click', (e) => {
              e.preventDefault();
              e.stopPropagation();
              console.log('🔄 Language toggle clicked');
              this.toggleLanguage();
            });
            
            // Also add keyboard support
            ELEMENTS.toggleSwitch.addEventListener('keydown', (e) => {
              if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                e.stopPropagation();
                console.log('🔄 Language toggle activated via keyboard');
                this.toggleLanguage();
              }
            });
            
            // Make it focusable for accessibility
            ELEMENTS.toggleSwitch.setAttribute('tabindex', '0');
          }
          
          console.log('✅ Language toggle enabled and ready');
        },

        renderLyrics(lyrics, language) {
          const { html, orderedSections } = this.parseSections(lyrics);
          
          if (ELEMENTS.songLyrics) {
            ELEMENTS.songLyrics.innerHTML = html;
          }

          // Update language styling
          this.updateLanguageDisplay(language);

          // Create navigation buttons
          this.renderSectionButtons(orderedSections);

          // Create section overlays
          setTimeout(() => {
            this.createSectionOverlays(orderedSections);
          }, 100);
        },

        parseSections(lyrics) {
          const lines = lyrics.split('\n');
          let orderedSections = [];
          let htmlSections = [];
          let currentSection = null;
          let sectionType = null;
          let sectionId = null;
          let sectionName = null;

          const pushSection = () => {
            if (currentSection && currentSection.trim()) {
              const blockClass = 'section-block';
              htmlSections.push(`<div class="${blockClass}" id="${sectionId}"><div class="section-name-overlay">${sectionName}</div>${currentSection}</div>`);
            }
          };

          const highlightAmpersandParts = (line) => {
            return line.replace(/&([^&]*)&/g, `<span class="highlight-line">$1</span>`);
          };

          lines.forEach((line) => {
            const trimmedLine = line.trim();
            
            if (/^-+$/.test(trimmedLine)) {
              pushSection();
              htmlSections.push('<div class="break-line"></div>');
              currentSection = null;
              return;
            }
            
            if (/^[#$][A-Za-z0-9]+/.test(trimmedLine)) {
              pushSection();
              
              sectionType = trimmedLine.startsWith('#') ? 'yellow' : 'white';
              sectionName = trimmedLine.substring(1);
              sectionId = this.slugify(trimmedLine);
              
              orderedSections.push({
                id: sectionId,
                name: sectionName,
                type: sectionType,
                fullName: trimmedLine
              });
              
              currentSection = '';
              return;
            }
            
            if (currentSection === null) {
              sectionType = 'yellow';
              sectionName = 'M';
              sectionId = this.slugify('#M');
              
              orderedSections.push({
                id: sectionId,
                name: sectionName,
                type: sectionType,
                fullName: '#M'
              });
              
              currentSection = '';
            }
            
            if (trimmedLine) {
              let processedLine = trimmedLine;
              
              if (processedLine.startsWith('*')) {
                processedLine = processedLine.substring(1).trim();
                processedLine = `<span class="highlight-line">${processedLine}</span>`;
              }
              
              processedLine = highlightAmpersandParts(processedLine);
              currentSection += processedLine + '\n';
            }
          });
          
          pushSection();
          return { html: htmlSections.join(''), orderedSections };
        },

        slugify(text) {
          return text
            .toLowerCase()
            .trim()
            .replace(/[^\w\s-]/g, '')
            .replace(/[\s_-]+/g, '-')
            .replace(/^-+|-+$/g, '');
        },

        renderSectionButtons(orderedSections) {
          if (!ELEMENTS.sectionNavBar) return;

          ELEMENTS.sectionNavBar.innerHTML = '';
          orderedSections.forEach((section) => {
            const btn = document.createElement('button');
            btn.className = section.type === 'yellow' ? 'yellow-btn' : 'white-btn';
            btn.textContent = section.name;
            btn.onclick = () => {
              const element = document.getElementById(section.id);
              if (element) {
                element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                element.classList.add('flash');
                setTimeout(() => element.classList.remove('flash'), 1000);
              }
            };
            ELEMENTS.sectionNavBar.appendChild(btn);
          });
        },

        createSectionOverlays(orderedSections) {
          document.querySelectorAll('.section-name-overlay').forEach(overlay => overlay.remove());
          
          orderedSections.forEach(section => {
            const sectionElement = document.getElementById(section.id);
            if (sectionElement) {
              const overlay = document.createElement('div');
              overlay.className = 'section-name-overlay';
              if (STATE.currentLanguage === 'english') {
                overlay.classList.add('english');
              }
              overlay.textContent = section.name;
              sectionElement.appendChild(overlay);
            }
          });
        },

        updateLanguageDisplay(language) {
          STATE.currentLanguage = language;
          
          // Update toggle slider position
          this.updateToggleState(language);
          
          // Update section navigation bar position
          if (ELEMENTS.sectionNavBar) {
            if (language === 'english') {
              ELEMENTS.sectionNavBar.classList.add('english');
            } else {
              ELEMENTS.sectionNavBar.classList.remove('english');
            }
          }
          
          // Update lyrics template styling
          if (ELEMENTS.lyricsTemplate) {
            if (language === 'english') {
              ELEMENTS.lyricsTemplate.classList.add('english');
              ELEMENTS.lyricsTemplate.style.direction = 'ltr';
              ELEMENTS.lyricsTemplate.style.textAlign = 'left';
            } else {
              ELEMENTS.lyricsTemplate.classList.remove('english');
              ELEMENTS.lyricsTemplate.style.direction = 'rtl';
              ELEMENTS.lyricsTemplate.style.textAlign = 'right';
            }
          }
        },

        toggleLanguage() {
          console.log('🔄 Toggle language called:', { 
            currentLanguage: STATE.currentLanguage, 
            englishAvailable: STATE.englishAvailable,
            hasEnglishLyrics: !!STATE.generatedEnglishLyrics,
            toggleReady: ELEMENTS.toggleSwitch && ELEMENTS.toggleSwitch.classList.contains('ready')
          });
          
          // Check if toggle is in ready state and English is available
          if (!STATE.englishAvailable || !STATE.generatedEnglishLyrics || 
              !ELEMENTS.toggleSwitch || !ELEMENTS.toggleSwitch.classList.contains('ready')) {
            console.warn('⚠️ English lyrics not available yet or toggle not ready');
            
            // Give visual feedback that it's not ready
            if (ELEMENTS.toggleSwitch) {
              ELEMENTS.toggleSwitch.style.animation = 'shake 0.5s';
              setTimeout(() => {
                if (ELEMENTS.toggleSwitch) {
                  ELEMENTS.toggleSwitch.style.animation = '';
                }
              }, 500);
            }
            return;
          }
          
          const newLanguage = STATE.currentLanguage === 'dhivehi' ? 'english' : 'dhivehi';
          const lyrics = newLanguage === 'dhivehi' ? STATE.currentSong.lyrics : STATE.generatedEnglishLyrics;
          
          console.log(`🔄 Switching to ${newLanguage} language`);
          
          // Update the toggle UI immediately for snappy response
          this.updateToggleState(newLanguage);
          
          // Render the lyrics with smooth transition
          this.renderLyrics(lyrics, newLanguage);
          
          console.log('✅ Language switched successfully');
        },

        updateToggleState(language) {
          console.log('🔄 Updating toggle state to:', language);
          
          // Update the slider element reference if needed
          if (!ELEMENTS.toggleSlider && ELEMENTS.toggleSwitch) {
            ELEMENTS.toggleSlider = ELEMENTS.toggleSwitch.querySelector('#toggle-slider');
          }
          
          if (ELEMENTS.toggleSlider) {
            if (language === 'english') {
              ELEMENTS.toggleSlider.classList.add('english');
              ELEMENTS.toggleSlider.textContent = 'English';
              console.log('✅ Toggle slider set to English position');
            } else {
              ELEMENTS.toggleSlider.classList.remove('english');
              ELEMENTS.toggleSlider.textContent = 'ދިވެހި';
              console.log('✅ Toggle slider set to Dhivehi position');
            }
          } else {
            console.warn('⚠️ Toggle slider element not found');
          }
        },

        showUI() {
          // Ensure all page elements are ready before showing
          const container = document.querySelector('.container');
          const lyricsTemplate = ELEMENTS.lyricsTemplate;
          const sectionNavBar = ELEMENTS.sectionNavBar;
          const songTitle = ELEMENTS.songTitle;
          
          // Check if all essential elements exist and have content
          const allElementsReady = container && lyricsTemplate && songTitle && 
                                 songTitle.textContent && songTitle.textContent.trim() !== '';
          
          if (!allElementsReady) {
            console.warn('Not all elements ready for UI display');
            // Try again after a short delay
            setTimeout(() => this.showUI(), 50);
            return;
          }
          
          // Show content immediately for faster perceived loading
          if (container) {
            container.classList.add('ready');
            container.style.opacity = '1';
            container.style.visibility = 'visible';
            container.style.transform = 'translateY(0)';
          }
          
          if (lyricsTemplate) {
            lyricsTemplate.style.display = 'block';
            lyricsTemplate.classList.add('ready');
          }
          
          if (sectionNavBar) {
            sectionNavBar.classList.add('ready');
          }
          
          // Wait for content to be rendered, then hide loading screen
          requestAnimationFrame(() => {
            requestAnimationFrame(() => {
              // Double RAF to ensure content is painted
              setTimeout(() => {
                // Use forceHide to override navigation mode protection
                if (LoadingScreen && typeof LoadingScreen.forceHide === 'function') {
                  LoadingScreen.forceHide();
                } else {
                  LoadingScreen.hide();
                }
              }, 100); // Small delay to ensure smooth transition
            });
          });
        },

        showError(message) {
          if (ELEMENTS.songTitle) {
            ELEMENTS.songTitle.textContent = 'Error';
          }
          if (ELEMENTS.songLyrics) {
            ELEMENTS.songLyrics.innerHTML = message;
          }
          if (ELEMENTS.lyricsTemplate) {
            ELEMENTS.lyricsTemplate.style.display = 'block';
          }
          
          // Ensure loading screen is hidden when showing error
          if (LoadingScreen && typeof LoadingScreen.forceHide === 'function') {
            LoadingScreen.forceHide();
          } else {
            LoadingScreen.hide();
          }
          this.showUI();
        }
      };

      // Main Application
      const App = {
        async init() {
          try {
            LoadingScreen.init();
            LoadingScreen.show('Loading lyrics...');

            // Wait for shared services
            await this.waitForServices();

            // Set up data service event listeners to use our loading screen
            this.setupDataServiceListeners();

            // Initialize components
            PinManager.init();
            LyricsManager.init();

            STATE.isInitialized = true;
            
            // Add failsafe to ensure loading screen doesn't stay forever
            setTimeout(() => {
              if (document.querySelector('.loading-screen:not(.fade-out)')) {
                console.warn('Loading screen failsafe triggered - hiding after 10 seconds');
                LoadingScreen.hide();
              }
            }, 10000);
            
          } catch (error) {
            console.error('Failed to initialize lyrics app:', error);
            LoadingScreen.updateProgress('Loading lyrics...');
            
            // Ensure loading screen is hidden on error
            setTimeout(() => LoadingScreen.hide(), 2000);
          }
        },

        setupDataServiceListeners() {
          // Intercept data service loading events and use our loading screen
          if (window.RhythmData) {
            window.RhythmData.on('loadingStart', (type) => {
              // Don't show loading screen if already showing PIN overlay
              if (!ELEMENTS.pinOverlay || ELEMENTS.pinOverlay.classList.contains('hidden')) {
                LoadingScreen.show('Loading lyrics...');
              }
            });

            window.RhythmData.on('loadingProgress', (message) => {
              LoadingScreen.updateProgress('Loading lyrics...');
            });

            window.RhythmData.on('loadingComplete', (type) => {
              // Don't hide if we're in the process of loading song data
              if (type === 'songs' && !STATE.isInitialized) {
                LoadingScreen.updateProgress('Loading lyrics...');
              }
            });

            window.RhythmData.on('loadingError', (type, error) => {
              console.error(`Data loading error for ${type}:`, error);
              LoadingScreen.updateProgress('Loading lyrics...');
            });
          }
        },

        async waitForServices() {
          return new Promise((resolve) => {
            let attempts = 0;
            const maxAttempts = 20; // 2 seconds max wait
            
            const checkServices = () => {
              attempts++;
              if (window.RhythmSession && window.RhythmData && window.RhythmPageTransition) {
                resolve();
              } else if (attempts >= maxAttempts) {
                console.warn('Shared services not available, continuing with fallback');
                resolve();
              } else {
                setTimeout(checkServices, 100);
              }
            };
            checkServices();
          });
        },

        async loadSongData() {
          if (!window.RhythmSession.isAuthenticated()) {
            return;
          }

          // Keep the same loading message for seamless experience
          LoadingScreen.updateProgress('Loading lyrics...');
          
          try {
            // Use cached data for faster loading - don't force refresh
            if (window.RhythmData) {
              // Only load if we don't have any data at all
              if (window.RhythmData.songs.length === 0) {
                LoadingScreen.updateProgress('Loading lyrics...');
                await window.RhythmData.loadSongsData(false, true); // Skip loading events
              }
            }
            
            LoadingScreen.updateProgress('Loading lyrics...');
            
            // Load the specific song
            await LyricsManager.loadSong();
          } catch (error) {
            console.error('Failed to load song data:', error);
            LyricsManager.showError('Failed to load song');
          }
        }
      };

      // Global functions for backward compatibility
      window.toggleLanguage = () => {
        console.log('🔄 Global toggleLanguage called');
        if (LyricsManager && typeof LyricsManager.toggleLanguage === 'function') {
          LyricsManager.toggleLanguage();
        } else {
          console.warn('⚠️ LyricsManager.toggleLanguage not available');
        }
      };

      // Initialize application
      document.addEventListener('DOMContentLoaded', () => {
        App.init();
      });

      return App;
    })();
  </script>
</body>
</html>
